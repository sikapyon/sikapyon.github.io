<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Mini Civilization â€“ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–ï¼‹ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
<style>
  :root{ --size:64px; --gap:8px; }
  /* ===== èƒŒæ™¯(æ™‚ä»£é·ç§») ===== */
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; color:#222;
        transition:background 600ms ease, color 200ms; }
  body.era-1{ background:linear-gradient(#e7f6ff,#f7fbff); }
  body.era-2{ background:linear-gradient(#e9ffe7,#f7fff5); }
  body.era-3{ background:linear-gradient(#fef7e4,#fffdf5); }
  body.era-4{ background:linear-gradient(#f7f1ff,#ffffff); }
  body.era-5{ background:radial-gradient(1000px 600px at 50% 120%, #0b1c3f,#09152e 60%, #070d1c 100%); color:#e9edff;}
  header{ padding:14px 16px; background:#fff; border-bottom:1px solid #e3e6ef; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  body.era-5 header{ background:#0e1833; border-color:#1f2b4f; }
  h1{ font-size:18px; margin:0; }
  .wrap{ padding:16px; display:grid; gap:16px; max-width:1100px; margin:0 auto; }
  .card{ background:#fff; border:1px solid #e3e6ef; border-radius:12px; padding:14px; transition:background 300ms,border-color 300ms; }
  body.era-5 .card{ background:#0f1a37; border-color:#233058; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .pill{ padding:4px 8px; background:#eef1ff; border-radius:999px; font-size:12px;}
  body.era-5 .pill{ background:#19244a; }
  button{ cursor:pointer; border-radius:8px; border:1px solid #cfd5ea; background:#fff; padding:8px 12px; font-weight:600; }
  button:hover{ background:#f0f3ff;} button:disabled{ opacity:.5; cursor:not-allowed;}
  body.era-5 button{ background:#132049; border-color:#2d3a61; color:#e9edff; }
  body.era-5 button:hover{ background:#1a2a58; }

  .grid{ display:grid; grid-template-columns:repeat(5,var(--size)); grid-auto-rows:var(--size); gap:var(--gap); }
  .cell{ display:grid; place-items:center; border-radius:10px; box-shadow:0 0 0 1px #d7dbe8 inset; user-select:none; font-size:22px; transition:transform .12s ease, box-shadow .2s; }
  body.era-5 .cell{ box-shadow:0 0 0 1px #33406d inset; color:#eef2ff;}
  .cell.pulse{ animation:pulse .28s ease; } @keyframes pulse{50%{transform:scale(1.06);} }
  .cell.flash{ box-shadow:0 0 0 3px #6a8cff inset; animation:flashOut .6s ease; }
  @keyframes flashOut{ 0%{box-shadow:0 0 0 3px #6a8cff inset;} 100%{box-shadow:0 0 0 1px #d7dbe8 inset;} }
  body.era-5 .cell.flash{ box-shadow:0 0 0 3px #8cb0ff inset; }
  .white{ background:#fff; }
  .grey{ background:#d7dbe8; }
  body.era-5 .white{ background:#152554; } body.era-5 .grey{ background:#23305a; }
  .chosen{ outline:3px solid #6a8cff; }
  .tracks{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .section-title{ font-weight:700; margin:6px 0; }
  .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  .small{ font-size:12px; color:#5b6175;} body.era-5 .small{ color:#b7c3ff;}
  .boardWrap{ position:relative;}
  svg.lines{ position:absolute; inset:0; pointer-events:none;}
  .res{ display:flex; gap:10px; flex-wrap:wrap; }
  .res > div{ position:relative; background:#f3f5ff; border:1px solid #dfe3f7; border-radius:10px; padding:6px 10px; }
  body.era-5 .res > div{ background:#182550; border-color:#2c3a63; }
  .slot{ display:inline-flex; align-items:center; gap:6px; border:1px dashed #cfd5ea; border-radius:8px; padding:4px 6px; margin:4px; }
  body.era-5 .slot{ border-color:#324071; }
  dialog{ border:1px solid #ccd3ee; border-radius:12px; padding:12px 14px; }
  dialog::backdrop{ background:rgba(0,0,0,.2); }
  .inp{ width:60px; padding:4px 6px; border:1px solid #cfd5ea; border-radius:8px; }
  .tbl{ border-collapse:collapse; margin-top:10px; }
  .tbl th,.tbl td{ border:1px solid #cfd5ea; padding:4px 6px; text-align:center; }
  .tbl th{ background:#f3f5ff; } body.era-5 .tbl th{ background:#1b2a59; border-color:#2d3a61; }
  body.era-5 .tbl td{ border-color:#2d3a61; }

  /* åŸºæº–å€¤ãƒãƒ¼ */
  #baselineBar{ margin-top:6px; }
  #baselineBar .chip{ display:inline-block; padding:2px 6px; border:1px solid #cfd5ea; border-radius:999px; margin-right:6px; background:#f6f8ff; transition:background .2s; }
  #baselineBar.bump .chip:first-child{ background:#e9f0ff; }
  body.era-5 #baselineBar .chip{ background:#16244f; border-color:#2c3a61; }

  /* æ–‡æ˜è©•ä¾¡ãƒãƒŠãƒ¼ */
  .score-banner{ margin-top:8px; padding:10px 12px; border:1px solid #d6e0ff; background:#f6f8ff; border-radius:12px; display:flex; align-items:center; gap:10px; position:relative; overflow:visible; }
  .score-badge{ font-weight:700; padding:4px 8px; border-radius:999px; background:#e8efff; border:1px solid #c9d7ff; }
  .score-title{ font-weight:800; }
  .score-sub{ font-size:12px; color:#5b6175; }

  /* ç·šã®ãƒ‰ãƒ­ãƒ¼ã‚¢ãƒ‹ãƒ¡ */
  .seg-draw{ stroke-dasharray:var(--len); stroke-dashoffset:var(--len); animation:draw .35s ease forwards; }
  @keyframes draw{ to{ stroke-dashoffset:0; } }
  /* äº¤å·®ç«èŠ± */
  .spark{ fill:#ffd54a; opacity:0; animation:spark .6s ease forwards; }
  @keyframes spark{ 0%{opacity:0; transform:scale(.5);} 40%{opacity:1;} 100%{opacity:0; transform:scale(1.5);} }

  /* ãƒªã‚½ãƒ¼ã‚¹+1ãƒãƒƒãƒ— */
  .gain-pop{ position:absolute; left:50%; transform:translateX(-50%); pointer-events:none; font-weight:700; }
  .gain-pop.anim{ animation:popUp .6s ease forwards; }
  @keyframes popUp{ 0%{opacity:0; transform:translate(-50%,10px) scale(.9);} 20%{opacity:1;} 100%{opacity:0; transform:translate(-50%,-18px) scale(1);} }

  /* å±¥æ­´ */
  #historyList{ display:flex; flex-direction:column; gap:6px; max-height:220px; overflow:auto; }
  .hist-item{ display:flex; gap:8px; align-items:center; font-size:12px; background:#fbfcff; border:1px solid #e4e8fb; border-radius:10px; padding:6px 8px; }
  .hist-turn{ font-weight:800; color:#445; }
  .hist-meta{ color:#667; }

  /* å»ºç¯‰ãƒãƒ¼ */
  #cityBar{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  #cityRow{ font-size:22px; letter-spacing:2px; }

  /* å¤–äº¤/èŠ¸è¡“/ç™ºæ˜ã®è¦–è¦šãƒˆãƒ©ãƒƒã‚«ãƒ¼ */
  .trackbox{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;}
  .ticks{ display:flex; gap:3px; }
  .tick{ width:16px; height:16px; border:1px solid #b8c0e6; border-radius:3px; background:#fff; position:relative; }
  .tick.filled::after{ content:""; position:absolute; inset:3px; background:#6aa8ff; border-radius:2px; }
  .tick.checked::after{ content:"âœ“"; position:absolute; inset:0; font-size:12px; color:#fff; display:grid; place-items:center; background:#6aa8ff; border-radius:2px; }
  body.era-5 .tick{ background:#152554; border-color:#2d3a61; }
  body.era-5 .tick.filled::after, body.era-5 .tick.checked::after{ background:#7fb2ff; }

  .inv-bulb{ width:20px; height:20px; border-radius:6px; border:1px solid #b8c0e6; display:grid; place-items:center; background:#fff; }
  .inv-bulb.on{ background:#fff7cc; border-color:#e8d067; }
  .inv-bulb.used{ background:#d9deef; color:#7a839f; }
  body.era-5 .inv-bulb{ background:#152554; border-color:#2d3a61; color:#e9edff; }
  body.era-5 .inv-bulb.on{ background:#463b00; }
  body.era-5 .inv-bulb.used{ background:#1f2b4f; }

  /* ç´™å¹é›ª */
  .confetti{ position:absolute; width:6px; height:10px; opacity:.9; }
  @keyframes fall { to { transform: translateY(120px) rotate(360deg); opacity:.2; } }
</style>
</head>
<body class="era-1">
<header>
  <h1>Mini Mini Civilization â€“ ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆ</h1>
  <span class="pill">åŸºæº–å€¤: <span id="baseline">12</span></span>
  <span class="pill">æ‰‹æ•°: <span id="turn">0</span>/25</span>
  <label class="pill">åŸºæº–æ–¹å¼:
    <select id="mode"><option value="solo">å…¬å¼ã‚½ãƒ­ï¼ˆè¿‘å‚ã¸è‡ªå‹•ï¼‰</option><option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option></select>
  </label>
  <label class="pill">ç«¶äº‰:
    <select id="compMode"><option value="solo">ã‚½ãƒ­ï¼ˆé–¾å€¤æ¯”è¼ƒï¼‰</option><option value="multi">2äººä»¥ä¸Šï¼ˆå·¦å³æ¯”è¼ƒï¼‰</option></select>
  </label>
  <button id="resetAll">å…¨é¢ãƒªã‚»ãƒƒãƒˆ</button>
</header>

<div class="wrap">
  <!-- ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ -->
  <section class="card">
    <div class="row"><div class="section-title">ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ï¼ˆç™½ãƒã‚¹ã« 5â€“20ã€ã‚°ãƒ¬ãƒ¼ã¯æœªè¨˜å…¥ï¼‰</div>
      <button id="randomFill">5â€“20ã‚’ãƒ©ãƒ³ãƒ€ãƒ é…ç½®</button>
      <button id="clearNums">æ•°å­—ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="boardWrap">
      <div id="board" class="grid" aria-label="5x5 board"></div>
      <svg id="lines" class="lines"></svg>
    </div>
    <div id="baselineBar" class="small mono"></div>
    <div id="cityBar" class="small"><b>ç™ºå±•åº¦:</b> <span id="cityRow"></span></div>
    <div class="small">1æ‰‹ç›®ã¯è‡ªç”±ã€ä»¥é™ã¯<strong>éš£æ¥8æ–¹å‘</strong>ã®ã¿ã€‚æœªè¨˜å…¥ãƒã‚¹ï¼ˆç™½/ç°ï¼‰ã‚’é¸ã¶ã¨è‡ªå‹•ã§ã€Œ1ã€ã‚’æ›¸ãè¾¼ã¿ã€ãã®æ•°ã§åˆ¤å®šï¼ˆè³‡æºãªã—ï¼‰ã€‚<span id="pendingHint" class="small"></span></div>
  </section>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <section class="card">
    <div class="section-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
    <div class="res">
      <div>ğŸ é£Ÿæ–™: <span id="rFood">0</span></div>
      <div>ğŸ§ª ç§‘å­¦: <span id="rSci">0</span></div>
      <div>âš™ ç”£æ¥­: <span id="rInd">0</span></div>
      <div>ğŸ–‹ èŠ¸è¡“: <span id="rArt">0</span></div>
      <div>ğŸ‘ å¤–äº¤: <span id="rDip">0</span></div>
      <div>ğŸ’¡ ç™ºæ˜(æœªä½¿ç”¨): <span id="rInv">0</span></div>
    </div>

    <!-- å¤–äº¤ãƒ»èŠ¸è¡“ãƒ»ç™ºæ˜ã®ãƒã‚§ãƒƒã‚¯å¼ãƒˆãƒ©ãƒƒã‚«ãƒ¼ -->
    <div id="trackVisual" class="trackbox"></div>

    <div class="tracks">
      <div>
        <div class="section-title">é–‹æ‹“ï¼ˆå¥‡æ•°ã‹ã¤åŸºæº–ã‚ˆã‚Šå¤§ï¼‰</div>
        <div id="frontier" class="mono small"></div>
        <div class="small">ãƒˆãƒ©ãƒƒã‚¯ï¼š<span class="mono">21, 1, 22, 2, 23, 3, 24, 4, 25</span>ã€‚é¸ã¶ã¨ãã®ç•ªå·ã¨å·¦å´ãŒÃ—ã€‚æ¬¡ã«ã‚°ãƒ¬ãƒ¼ã¸æ›¸ãè¾¼ã¿ï¼ˆã“ã®æ™‚ã®ã¿ğŸ/ğŸ‘ç²å¾—ï¼‰ã€‚æº€æ¯ãªã‚‰ğŸ+1ã€‚</div>
      </div>
      <div>
        <div class="section-title">ç ”ç©¶ï¼ˆå¶æ•°ã‹ã¤åŸºæº–ã‚ˆã‚Šå¤§ï¼‰</div>
        <div id="researchSlots" class="small"></div>
        <div id="researchTableWrap"></div>
        <div class="small" style="margin-top:6px;">çµ‚äº†æ™‚è¨ˆç®—ï¼šå·¦â†’å³ã§<b>å€¤ãŒä¸Šæ˜‡ã—ç¶šã‘ã‚‹</b>é€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸‰è§’æ•°ï¼ˆ1,3,6,10,15,21â€¦ï¼‰ã‚’åŠ ç®—ã€‚</div>
      </div>
    </div>

    <div class="section-title">æ•™è‚²ï¼ˆåŸºæº–ä»¥ä¸‹ï¼‰</div>
    <div class="small">1â€“5â†’âš™1/ğŸ–‹2ã€6â€“10â†’âš™2/ğŸ–‹1ã€11â€“15â†’âš™4/ğŸ–‹2ã€16â€“20â†’âš™6/ğŸ–‹2ã€21â€“25â†’âš™8/ğŸ–‹3ã€‚</div>
  </section>

  <!-- å±¥æ­´ã¨å¾—ç‚¹ -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end;">
      <div>
        <div class="section-title">UNDOå±¥æ­´</div>
        <div id="historyList"></div>
      </div>
      <div>
        <div class="section-title">å¾—ç‚¹è¨ˆç®—</div>
        <div class="row">
          <button id="undoBtn">â†© ä¸€æ‰‹æˆ»ã™</button>
          <button id="scoreBtn">å¾—ç‚¹è¨ˆç®—</button>
        </div>
        <div id="scoreOut" class="mono"></div>
      </div>
    </div>
    <div class="small">åˆè¨ˆ = ğŸ’¡ç™ºæ˜ + æ–‡åŒ–(min) + ç«¶äº‰ + è‡ªç„¶ã€‚ã‚½ãƒ­é–¾å€¤ï¼šğŸ§ª25, âš™25, ğŸ‘14, ğŸ–‹15ã€‚æœªä½¿ç”¨ğŸ’¡Ã—1ã€min(ğŸ,ğŸ§ª,âš™) ã‚’åŠ ç®—ã€‚è‡ªç„¶=é–‹æ‹“æœªÃ—ã®æ•°ã€‚</div>
  </section>

  <!-- ç«¶äº‰UI -->
  <section class="card" id="compPanel">
    <div class="row">
      <div class="section-title">ç«¶äº‰å…¥åŠ›ï¼ˆ2äººä»¥ä¸Šæ™‚ï¼‰</div>
      <label>å·¦ğŸ§ª<input class="inp" id="L_sci" type="number" value="0"></label>
      <label>å·¦âš™<input class="inp" id="L_ind" type="number" value="0"></label>
      <label>å·¦ğŸ‘<input class="inp" id="L_dip" type="number" value="0"></label>
      <label>å·¦ğŸ–‹<input class="inp" id="L_art" type="number" value="0"></label>
      <label>å³ğŸ§ª<input class="inp" id="R_sci" type="number" value="0"></label>
      <label>å³âš™<input class="inp" id="R_ind" type="number" value="0"></label>
      <label>å³ğŸ‘<input class="inp" id="R_dip" type="number" value="0"></label>
      <label>å³ğŸ–‹<input class="inp" id="R_art" type="number" value="0"></label>
    </div>
    <div class="small">å·¦å³ã¨å„ã‚«ãƒ†ã‚´ãƒªã§ã€ŒåŒã˜ã‹ä¸Šã€ãªã‚‰å„1ç‚¹ï¼ˆæœ€å¤§8ç‚¹ï¼‰ã€‚</div>
  </section>
</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆç¢ºå®šãªã—ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«=UNDOï¼‰ -->
<dialog id="actionDlg">
  <form method="dialog">
    <div class="section-title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div id="actionInfo" class="mono small"></div>
    <div id="actionBody"></div>
    <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-start;">
      <button id="btnUndo" value="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã“ã®æ‰‹ã‚’å–ã‚Šæ¶ˆã™ï¼‰</button>
    </div>
  </form>
</dialog>

<script>
/* ====== å‚ç…§ ====== */
const board = document.getElementById('board');
const lines = document.getElementById('lines');
const baselineEl = document.getElementById('baseline');
const turnEl = document.getElementById('turn');
const modeSel = document.getElementById('mode');
const compSel = document.getElementById('compMode');
const compPanel = document.getElementById('compPanel');
const actionDlg = document.getElementById('actionDlg');
const actionInfo = document.getElementById('actionInfo');
const actionBody = document.getElementById('actionBody');
const btnUndo = document.getElementById('btnUndo');
const pendingHint = document.getElementById('pendingHint');
const historyList = document.getElementById('historyList');
const cityRow = document.getElementById('cityRow');
const trackVisual = document.getElementById('trackVisual');
const r = (id)=>document.getElementById(id);

/* ====== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ====== */
const res = { food:0, sci:0, ind:0, art:0, dip:0, inv:0 };
const stat = { invEarned:0, invSpent:0 }; // å¯è¦–åŒ–ç”¨ï¼ˆç·ç²å¾—/ä½¿ç”¨æ¸ˆï¼‰
function updRes(){ r('rFood').textContent=res.food; r('rSci').textContent=res.sci; r('rInd').textContent=res.ind; r('rArt').textContent=res.art; r('rDip').textContent=res.dip; r('rInv').textContent=res.inv; renderTracker(); }

/* ãƒªã‚½ãƒ¼ã‚¹+1ãƒãƒƒãƒ— */
function popGain(key, amt){
  if(amt<=0) return;
  const targetId = key==='food'?'rFood':key==='sci'?'rSci':key==='ind'?'rInd':key==='art'?'rArt':key==='dip'?'rDip':'rInv';
  const host = r(targetId).parentElement;
  for(let i=0;i<amt;i++){
    const span=document.createElement('span');
    const icon = {food:'ğŸ',sci:'ğŸ§ª',ind:'âš™',art:'ğŸ–‹',dip:'ğŸ‘',inv:'ğŸ’¡'}[key]||'+';
    span.className='gain-pop anim'; span.textContent=`${icon}+1`;
    host.appendChild(span); setTimeout(()=>host.removeChild(span),650);
  }
}
function addRes(key, amt){
  res[key]+=amt; popGain(key, Math.abs(amt));
  if(key==='dip'){ const got=Math.floor(res.dip/5)-Math.floor((res.dip-amt)/5); if(got>0){ addRes('art',got); } }
  if(key==='art'){ const got=Math.floor(res.art/4)-Math.floor((res.art-amt)/4); if(got>0){ stat.invEarned+=got; addRes('inv',got); } }
  updRes();
}

/* ====== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ====== */
let cells=[], path=[], baseline=12, usedNumbers=new Set([12]);
const frontierNumbers=[21,1,22,2,23,3,24,4,25];
let frontierX = new Set();
let research = []; // 12 slots
let pendingGrey = null;  // { devNum, baselineSource, flashCellIJ, preSnap, fromTxt, toTxt }
let moveSnapshot = null; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä¸­ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ç”¨ï¼ˆã‚¯ãƒªãƒƒã‚¯å‰ã®çŠ¶æ…‹ï¼‰
let snapshotStack = [];  // ç¢ºå®šã”ã¨ã®UNDO
let moveHistory = [];

/* å¹¾ä½• */
function triangular(n){ return n*(n+1)/2; }
function inBounds(i,j){ return i>=0&&i<5&&j>=0&&j<5; }
function neighbors(i,j){ const out=[]; for(let di=-1;di<=1;di++)for(let dj=-1;dj<=1;dj++){ if(di||dj){ const ni=i+di,nj=j+dj; if(inBounds(ni,nj)) out.push([ni,nj]); } } return out; }

/* ã‚°ãƒ¬ãƒ¼é…ç½®ã¨è³‡æº */
const greyMap = [
  [1,0,0,0,1],
  [0,1,0,1,0],
  [0,0,1,0,0],
  [0,1,0,1,0],
  [1,0,0,0,1],
];
function greyGain(i,j){
  const corner = (i===0&&j===0)||(i===0&&j===4)||(i===4&&j===0)||(i===4&&j===4);
  const center = (i===2&&j===2);
  if(center) return {food:2,dip:2}; if(corner) return {food:4,dip:1};
  return {food:3,dip:1};
}

/* ç ”ç©¶ã‚¹ãƒ­ãƒƒãƒˆè³‡æºï¼ˆå·¦â†’å³ï¼‰ */
const researchGain=[
  {art:1,dip:1},{sci:1,dip:1},{sci:1,dip:1},{dip:2},{dip:1},
  {food:1,dip:1},{food:1,dip:1},{dip:1},{dip:2},{sci:1,dip:1},{sci:1,dip:1},{art:1,dip:1},
];

/* ç›¤é¢ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆUNDOç”¨ï¼‰ */
function serializeBoard(){
  const vals=[], chosen=[];
  for(let i=0;i<5;i++){ vals[i]=[]; chosen[i]=[];
    for(let j=0;j<5;j++){ vals[i][j]=cells[i][j].dataset.value||''; chosen[i][j]=cells[i][j].classList.contains('chosen'); }
  }
  return {vals, chosen, path:JSON.parse(JSON.stringify(path))};
}
function applyBoard(state, animate=false){
  for(let i=0;i<5;i++) for(let j=0;j<5;j++){
    const c=cells[i][j];
    c.dataset.value=state.vals[i][j]; c.textContent=state.vals[i][j];
    c.classList.toggle('chosen', !!state.chosen[i][j]);
  }
  path = JSON.parse(JSON.stringify(state.path));
  fitSVG(animate);
}

/* ç·šæç”»ï¼ˆæœ€å¾Œã®ã¿ã‚¢ãƒ‹ãƒ¡ï¼‰ã€‚äº¤å·®æ¤œå‡ºã§ç«èŠ±ã€‚ */
function cellCenter([i,j]){ const s=parseFloat(getComputedStyle(board).getPropertyValue('--size')); const g=parseFloat(getComputedStyle(board).getPropertyValue('--gap')); return {x:j*(s+g)+s/2, y:i*(s+g)+s/2}; }
function segLen(ax,ay,bx,by){ const dx=bx-ax, dy=by-ay; return Math.sqrt(dx*dx+dy*dy); }
function segIntersect(a,b,c,d){
  function cross(x1,y1,x2,y2,x3,y3){ return (x2-x1)*(y3-y1)-(y2-y1)*(x3-x1);}
  const A=cross(a.x,a.y,b.x,b.y,c.x,c.y), B=cross(a.x,a.y,b.x,b.y,d.x,d.y), C=cross(c.x,c.y,d.x,d.y,a.x,a.y), D=cross(c.x,c.y,d.x,d.y,b.x,b.y);
  if((A===0&&B===0&&C===0&&D===0)) return null; // åŒä¸€ç›´ç·šä¸Šã¯ç„¡è¦–
  return (A*B<0 && C*D<0);
}
function addSpark(x,y){
  const s=document.createElementNS('http://www.w3.org/2000/svg','circle');
  s.setAttribute('cx',x); s.setAttribute('cy',y); s.setAttribute('r',6);
  s.setAttribute('class','spark'); lines.appendChild(s);
  setTimeout(()=>s.remove(),600);
}
function fitSVG(animate=false){
  const rect=board.getBoundingClientRect();
  lines.setAttribute('viewBox',`0 0 ${rect.width} ${rect.height}`);
  lines.innerHTML='';
  if(path.length<=1) return;
  const end = path.length-1;
  // æ—¢å­˜ç·š
  for(let k=1;k<end;k++){
    const a=cellCenter(path[k-1]), b=cellCenter(path[k]);
    const L=document.createElementNS('http://www.w3.org/2000/svg','line');
    L.setAttribute('x1',a.x); L.setAttribute('y1',a.y);
    L.setAttribute('x2',b.x); L.setAttribute('y2',b.y);
    L.setAttribute('stroke','#6a8cff'); L.setAttribute('stroke-width','3');
    lines.appendChild(L);
  }
  // ç›´è¿‘ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
  const a=cellCenter(path[end-1]), b=cellCenter(path[end]);
  const L = document.createElementNS('http://www.w3.org/2000/svg','line');
  L.setAttribute('x1',a.x); L.setAttribute('y1',a.y);
  L.setAttribute('x2',b.x); L.setAttribute('y2',b.y);
  L.setAttribute('stroke','#6a8cff'); L.setAttribute('stroke-width','3');
  if(animate){ const len=segLen(a.x,a.y,b.x,b.y); L.classList.add('seg-draw'); L.style.setProperty('--len',len); }
  lines.appendChild(L);

  // äº¤å·®åˆ¤å®šï¼ˆéå»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¨ï¼‰
  for(let k=1;k<end-1;k++){
    const p1=cellCenter(path[k-1]), p2=cellCenter(path[k]);
    if(segIntersect(p1,p2,a,b)){
      // ç«èŠ±ã‚’äº¤ç‚¹è¿‘è¾ºï¼ˆä¸­ç‚¹ï¼‰ã«
      addSpark((p1.x+p2.x)/2,(p1.y+p2.y)/2);
    }
  }
}
window.addEventListener('resize',()=>fitSVG(false));

/* ç ”ç©¶ãƒ†ãƒ¼ãƒ–ãƒ« */
function buildResearchTable(){
  const tbl=document.createElement('table'); tbl.className='tbl';
  const trh=document.createElement('tr'); for(let i=1;i<=12;i++){ const th=document.createElement('th'); th.textContent='#'+i; trh.appendChild(th); } 
  const trb=document.createElement('tr'); for(let i=0;i<12;i++){ const td=document.createElement('td'); td.textContent = (typeof research[i]==='number')? research[i] : 'ç©º'; trb.appendChild(td); }
  tbl.appendChild(trh); tbl.appendChild(trb);
  return tbl;
}

/* åŸºæº–ãƒãƒ¼ãƒ»éƒ½å¸‚ãƒãƒ¼ */
function renderBaselineBar(){
  const host = document.getElementById('baselineBar');
  const remaining=[]; for(let n=1;n<=25;n++) if(!usedNumbers.has(n)) remaining.push(n);
  host.classList.remove('bump');
  host.innerHTML=`<span class="chip">åŸºæº–: ${baseline}</span><span class="chip">ä½¿ç”¨: ${usedNumbers.size}/25</span><span class="rest">æ®‹ã‚Šï¼ˆæœªä½¿ç”¨ï¼‰: ${remaining.join(', ')||'ãªã—'}</span>`;
  requestAnimationFrame(()=>host.classList.add('bump'));
}
function updateCityAndEra(){
  // æš«å®šã‚¹ã‚³ã‚¢ï¼ˆç«¶äº‰/è‡ªç„¶ã¯0ã¨ã—ã¦è»½ãç®—å‡ºï¼‰
  const sciEnd = calcScienceFromResearch();
  const cultureMin = Math.min(res.food, res.sci + sciEnd, res.ind);
  const total = res.inv + cultureMin;

  // å»ºç¯‰ã—ãã„å€¤
  const steps = [5,10,15,20,25,30,35];
  const icons = ['ğŸ ','ğŸ˜ï¸','ğŸ›ï¸','ğŸ¯','ğŸ°','ğŸ™ï¸','ğŸš€'];
  let built=0; for(const t of steps){ if(total>=t) built++; }
  cityRow.textContent = icons.slice(0,built).join(' ');

  // æ™‚ä»£åˆ¤å®šï¼ˆæ‰‹æ•°ã¨ã‚¹ã‚³ã‚¢ã®å¤§ãã„æ–¹å¯„ã‚Šï¼‰
  const turn=Math.min(path.length,25);
  let eraByTurn = 1 + Math.floor((turn)/6); // 1..5
  let eraByScore = 1 + Math.floor(Math.min(total,35)/8); // 1..5
  const era = Math.max(1, Math.min(5, Math.max(eraByTurn, eraByScore)));
  document.body.className = 'era-' + era;
}

/* å¤–äº¤ãƒ»èŠ¸è¡“ãƒ»ç™ºæ˜ã®ãƒã‚§ãƒƒã‚¯å¼ãƒˆãƒ©ãƒƒã‚«ãƒ¼ */
function renderTracker(){
  trackVisual.innerHTML = '';
  // ğŸ‘ å¤–äº¤ï¼š5å€‹ã§1åŒºåˆ‡ã‚Š
  const dipWrap=document.createElement('div'); dipWrap.className='row'; dipWrap.innerHTML='<b>ğŸ‘ å¤–äº¤</b>';
  const dipTicks=document.createElement('div'); dipTicks.className='ticks';
  const dip= res.dip; const dipFull=Math.floor(dip/5), dipRest=dip%5;
  for(let g=0; g<dipFull; g++){ for(let k=0;k<5;k++){ const t=document.createElement('div'); t.className='tick checked'; dipTicks.appendChild(t); } const gap=document.createElement('span'); gap.style.width='8px'; dipTicks.appendChild(gap); }
  for(let k=0;k<dipRest;k++){ const t=document.createElement('div'); t.className='tick filled'; dipTicks.appendChild(t); }
  for(let k=dipRest;k<5;k++){ const t=document.createElement('div'); t.className='tick'; dipTicks.appendChild(t); }
  dipWrap.appendChild(dipTicks);
  trackVisual.appendChild(dipWrap);

  // ğŸ–‹ èŠ¸è¡“ï¼š4å€‹ã§1åŒºåˆ‡ã‚Šï¼ˆæº€äº†ã§ğŸ’¡å¢—ãˆã‚‹ï¼‰
  const artWrap=document.createElement('div'); artWrap.className='row'; artWrap.innerHTML='<b>ğŸ–‹ èŠ¸è¡“</b>';
  const artTicks=document.createElement('div'); artTicks.className='ticks';
  const art=res.art; const aFull=Math.floor(art/4), aRest=art%4;
  for(let g=0; g<aFull; g++){ for(let k=0;k<4;k++){ const t=document.createElement('div'); t.className='tick checked'; artTicks.appendChild(t); } const gap=document.createElement('span'); gap.style.width='8px'; artTicks.appendChild(gap); }
  for(let k=0;k<aRest;k++){ const t=document.createElement('div'); t.className='tick filled'; artTicks.appendChild(t); }
  for(let k=aRest;k<4;k++){ const t=document.createElement('div'); t.className='tick'; artTicks.appendChild(t); }
  artWrap.appendChild(artTicks);
  trackVisual.appendChild(artWrap);

  // ğŸ’¡ ç™ºæ˜ï¼šç·ç²å¾—ã¶ã‚“ã‚’é›»çƒã§è¡¨ç¤ºã€‚ä½¿ç”¨æ¸ˆã¿ã¯ã‚°ãƒ¬ãƒ¼åŒ–
  const invWrap=document.createElement('div'); invWrap.className='row'; invWrap.innerHTML='<b>ğŸ’¡ ç™ºæ˜</b>';
  const invRow=document.createElement('div'); invRow.className='ticks';
  const totalBulbs = Math.max(stat.invEarned, res.inv + stat.invSpent);
  const used = stat.invSpent;
  for(let i=0;i<totalBulbs;i++){
    const b=document.createElement('div'); b.className='inv-bulb on';
    b.textContent='ğŸ’¡'; if(i<used) b.classList.add('used');
    invRow.appendChild(b);
  }
  // æ®‹ã‚Š0ã§ã‚‚æ ãŒè¦‹ãˆã‚‹ã‚ˆã†æœ€ä½1å€‹ã¯è¡¨ç¤º
  if(totalBulbs===0){ const b=document.createElement('div'); b.className='inv-bulb used'; b.textContent='ğŸ’¡'; invRow.appendChild(b); }
  invWrap.appendChild(invRow);
  trackVisual.appendChild(invWrap);
}

/* åˆæœŸç”Ÿæˆ */
function buildBoard(){
  board.innerHTML=''; cells=[]; path=[]; lines.innerHTML='';
  baseline=12; usedNumbers=new Set([12]); frontierX.clear(); pendingGrey=null; pendingHint.textContent='';
  moveSnapshot=null; snapshotStack=[]; moveHistory=[]; renderHistory();
  baselineEl.textContent=baseline; turnEl.textContent='0';
  for(let i=0;i<5;i++){
    cells[i]=[];
    for(let j=0;j<5;j++){
      const div=document.createElement('div'); div.className='cell ' + (greyMap[i][j]?'grey':'white');
      div.dataset.i=i; div.dataset.j=j; div.dataset.value='';
      div.addEventListener('click', ()=>onPick(i,j));
      board.appendChild(div); cells[i][j]=div;
    }
  }
  fitSVG(false); renderFrontier(); renderResearch(); renderBaselineBar(); updateCityAndEra(); renderTracker();
}

/* ãƒ©ãƒ³ãƒ€ãƒ /ã‚¯ãƒªã‚¢ */
function randFill(){ const nums=[]; for(let n=5;n<=20;n++) nums.push(n); for(let k=nums.length-1;k>0;k--){ const j=Math.floor(Math.random()*(k+1)); [nums[k],nums[j]]=[nums[j],nums[k]]; } let idx=0; for(let i=0;i<5;i++)for(let j=0;j<5;j++){ const c=cells[i][j]; if(c.classList.contains('white')){ c.textContent=String(nums[idx]); c.dataset.value=String(nums[idx]); idx++; } else { c.textContent=''; c.dataset.value=''; } } }
function clearNums(){ for(const row of cells) for(const c of row){ if(c.classList.contains('white')){ c.textContent=''; c.dataset.value=''; } } }

/* Frontier/Research è¡¨ç¤º */
function renderFrontier(){ r('frontier').textContent = frontierNumbers.map(n=> frontierX.has(n)? `[${n}]` : String(n) ).join(' '); }
function renderResearch(){
  const wrap=r('researchSlots'); wrap.innerHTML='';
  const row=document.createElement('div');
  for(let i=0;i<12;i++){
    const span=document.createElement('span'); span.className='slot';
    const label = (typeof research[i]==='number')? `#${i+1}ã€${research[i]}ã€‘` : `#${i+1}ï¼ˆç©ºï¼‰`;
    const gains = ` ${Object.entries(researchGain[i]).map(([k,v])=>({food:'ğŸ',sci:'ğŸ§ª',ind:'âš™',art:'ğŸ–‹',dip:'ğŸ‘'}[k])+`+${v}`).join(' ')}`;
    span.textContent = `${label}${gains}`;
    row.appendChild(span);
  }
  wrap.appendChild(row);
  const host=r('researchTableWrap'); host.innerHTML=''; host.appendChild(buildResearchTable());
}

/* åŸºæº–å€¤æ›´æ–° */
function updateBaseline(lastPicked){
  const mode=modeSel.value;
  if(mode==='random'){
    const pool=[]; for(let n=1;n<=25;n++) if(!usedNumbers.has(n)) pool.push(n);
    if(pool.length>0) baseline = pool[Math.floor(Math.random()*pool.length)];
  }else{
    const greater = lastPicked>baseline; const dir = greater? 1 : -1;
    let candidate = lastPicked+dir;
    while(candidate>=1 && candidate<=25 && usedNumbers.has(candidate)) candidate+=dir;
    if(candidate<1 || candidate>25){ candidate = lastPicked-dir; while(candidate>=1 && candidate<=25 && usedNumbers.has(candidate)) candidate-=dir; }
    if(candidate>=1 && candidate<=25) baseline=candidate;
  }
  usedNumbers.add(baseline); baselineEl.textContent=baseline; renderBaselineBar();
}

/* ====== ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯å‰ã«ä¿å­˜ï¼‰ ====== */
function makeSnapshot(){
  return {
    baseline, used:new Set(usedNumbers), res:{...res}, stat:{...stat},
    research:research.slice(), frontierX:new Set(frontierX),
    board:serializeBoard()
  };
}
function restoreSnapshot(snap, animate=false){
  Object.assign(res, snap.res); Object.assign(stat, snap.stat); updRes();
  research = snap.research.slice(); frontierX = new Set(snap.frontierX);
  baseline = snap.baseline; baselineEl.textContent=baseline; usedNumbers = new Set(snap.used);
  applyBoard(snap.board, animate); renderBaselineBar(); renderFrontier(); renderResearch(); updateCityAndEra(); renderTracker();
}
function undoLastPick(){ if(!moveSnapshot){ actionDlg.close(); return; } restoreSnapshot(moveSnapshot,false); moveSnapshot=null; pendingGrey=null; pendingHint.textContent=''; actionDlg.close(); }
function undoLastConfirmed(){ if(snapshotStack.length===0) return; const snap=snapshotStack.pop(); restoreSnapshot(snap,false); moveHistory.pop(); renderHistory(); turnEl.textContent=String(path.length); }

/* å±¥æ­´ */
function deltaText(before, after){ const out=[]; const map={food:'ğŸ',sci:'ğŸ§ª',ind:'âš™',art:'ğŸ–‹',dip:'ğŸ‘',inv:'ğŸ’¡'}; for(const k of Object.keys(map)){ const d=after[k]-before[k]; if(d>0) out.push(`${map[k]}+${d}`); } return out.join(' '); }
function addHistory(entry){ moveHistory.push(entry); renderHistory(); }
function renderHistory(){ historyList.innerHTML=''; moveHistory.forEach(h=>{ const div=document.createElement('div'); div.className='hist-item'; const t=document.createElement('span'); t.className='hist-turn'; t.textContent=`${h.turn}.`; const main=document.createElement('span'); main.textContent=`${h.from}â†’${h.to} / ${h.action}`; const meta=document.createElement('span'); meta.className='hist-meta'; meta.textContent=`åŸºæº– ${h.baseBefore}â†’${h.baseAfter}  ${h.delta||''}`; div.append(t,main,meta); historyList.appendChild(div); }); }

/* ====== ãƒã‚¹é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯å‰ã«ä¿å­˜ï¼‰ ====== */
function onPick(i,j){
  if(pendingGrey) return;
  const c=cells[i][j];
  if(path.length){ const [pi,pj]=path[path.length-1]; const ok=neighbors(pi,pj).some(([ni,nj])=>ni===i&&nj===j); if(!ok) return; }
  if(c.classList.contains('chosen')) return;

  moveSnapshot = makeSnapshot();             // â† ã‚¯ãƒªãƒƒã‚¯å‰ã«ä¿å­˜
  if(!c.dataset.value){ c.textContent='1'; c.dataset.value='1'; }
  const val=Number(c.dataset.value);
  c.classList.add('chosen','pulse'); setTimeout(()=>c.classList.remove('pulse'),280);
  path.push([i,j]); fitSVG(true);

  const gt = val>baseline; const parity = val%2===0? 'even':'odd';
  showActionDialog({i,j,val,gt,parity});
}

/* ã‚¢ã‚¤ã‚³ãƒ³æ–‡å­—åŒ– */
function icon(k){ return {food:'ğŸ',sci:'ğŸ§ª',ind:'âš™',art:'ğŸ–‹',dip:'ğŸ‘',inv:'ğŸ’¡'}[k]||k; }
function gainStr(obj){ return Object.entries(obj).map(([k,v])=>`${icon(k)}+${v}`).join(' '); }

/* ã‚»ãƒ«ç¸å–ã‚Šãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
function flashCell(i,j){ const c=cells[i][j]; c.classList.add('flash'); setTimeout(()=>c.classList.remove('flash'),520); }

/* ====== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ====== */
function showActionDialog(ctx){
  actionDlg.close(); actionBody.innerHTML='';
  const {i,j,val,gt,parity}=ctx;
  let type = gt? (parity==='odd'?'é–‹æ‹“':'ç ”ç©¶') : 'æ•™è‚²';
  actionInfo.textContent = `é¸ã‚“ã æ•°å­—: ${val}  /  åŸºæº– ${baseline}  â†’  ${gt?'å¤§ãã„':'å°ã•ã„(åŒå€¤å«ã‚€)'}ãƒ»${parity==='odd'?'å¥‡æ•°':'å¶æ•°'}  â‡’  ${type}`;
  const fromTxt = path.length>1? cells[path[path.length-2][0]][path[path.length-2][1]].dataset.value : 'å§‹';
  const toTxt = val;

  // ğŸ’¡åè»¢
  const invBox=document.createElement('div'); invBox.className='small';
  const btnInv=document.createElement('button'); btnInv.type='button'; btnInv.textContent='ğŸ’¡1æ¶ˆè²»ã§ä¸Šä¸‹ã‚’åè»¢'; btnInv.disabled=(res.inv<=0);
  let flipped=false;
  btnInv.onclick=(e)=>{ e.preventDefault(); if(flipped||res.inv<=0) return; flipped=true; res.inv--; stat.invSpent++; updRes(); type = (type==='æ•™è‚²')? (parity==='odd'?'é–‹æ‹“':'ç ”ç©¶') : 'æ•™è‚²'; if(!/ï¼ˆğŸ’¡ä½¿ç”¨ï¼‰$/.test(actionInfo.textContent)) actionInfo.textContent+='ï¼ˆğŸ’¡ä½¿ç”¨ï¼‰'; btnInv.disabled=true; renderBody(); };
  invBox.append('ï¼ˆä»»æ„ï¼‰',btnInv); actionBody.appendChild(invBox);

  const body=document.createElement('div'); actionBody.appendChild(body);

  function finalize(preSnap, baseSource, extraLog, flashTarget){
    snapshotStack.push(preSnap);                    // ç€æ‰‹å‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ç©ã‚€
    const beforeRes = {...res}; const baseBefore = baseline;
    updateBaseline(baseSource);
    turnEl.textContent=String(path.length);
    renderResearch(); renderFrontier(); renderBaselineBar(); updateCityAndEra(); renderTracker();
    if(flashTarget){ flashCell(flashTarget[0],flashTarget[1]); }
    addHistory({ turn:path.length, from:fromTxt, to:toTxt, action:extraLog, baseBefore, baseAfter:baseline, delta:deltaText(beforeRes,res) });
    actionDlg.close(); moveSnapshot=null;
  }

  function renderBody(){
    body.innerHTML='';
    if(type==='é–‹æ‹“'){
      const allX = frontierNumbers.every(n=>frontierX.has(n));
      if(allX){
        const p=document.createElement('p'); p.className='small'; p.textContent='é–‹æ‹“ãƒˆãƒ©ãƒƒã‚¯ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã™ï¼ˆé–‹æ‹“ä¸å¯ï¼‰ã€‚ğŸ+1 ã‚’å¾—ã¾ã™ã€‚';
        const b=document.createElement('button'); b.type='button'; b.textContent='ğŸ +1 ã‚’å—ã‘å–ã‚‹';
        b.onclick=()=>{ const pre=moveSnapshot; addRes('food',1); finalize(pre, val, 'é–‹æ‹“ï¼ˆæº€æ¯æ•‘æ¸ˆï¼‰', [i,j]); };
        body.append(p,b); return;
      }
      body.appendChild(document.createTextNode('é–‹æ‹“ç•ªå·ã‚’é¸æŠï¼ˆå·¦å´ã™ã¹ã¦Ã—ï¼‰ã€‚æ¬¡ã«ä»»æ„ã®ã‚°ãƒ¬ãƒ¼ãƒã‚¹ã¸æ›¸ãè¾¼ã¿ã¾ã™ã€‚'));
      const list=document.createElement('div'); list.style.display='flex'; list.style.flexWrap='wrap'; list.style.gap='6px';
      frontierNumbers.forEach((n,idx)=>{
        const b=document.createElement('button');
        b.type='button'; b.textContent = frontierX.has(n)? `${n} Ã—` : String(n);
        if(frontierX.has(n)) b.disabled=true;
        b.onclick=()=>{ for(let k=0;k<=idx;k++) frontierX.add(frontierNumbers[k]); enableGreyWrite(n, val, [i,j], moveSnapshot, fromTxt, toTxt); actionDlg.close(); };
        list.appendChild(b);
      });
      body.appendChild(list);
    }else if(type==='ç ”ç©¶'){
      body.appendChild(document.createTextNode('ç ”ç©¶ã‚¹ãƒ­ãƒƒãƒˆã‚’1ã¤é¸ã³ã€ä»Šå›ã®æ•°å­—ã‚’æ›¸ãè¾¼ã¿ã¾ã™ï¼ˆã‚¹ãƒ­ãƒƒãƒˆã®è³‡æºã‚‚ç²å¾—ï¼‰ã€‚'));
      const slots=document.createElement('div'); slots.style.display='flex'; slots.style.flexWrap='wrap'; slots.style.gap='8px'; slots.style.marginTop='8px';
      for(let k=0;k<12;k++){
        const g = researchGain[k];
        const show = (typeof research[k]==='number')? `ã€${research[k]}ã€‘` : 'ç©º';
        const label = (typeof research[k]==='number') ? `#${k+1} ${show}` : `#${k+1} ${gainStr(g)} ã«æ›¸ãï¼ˆç©ºï¼‰`;
        const btn=document.createElement('button'); btn.type='button'; btn.textContent=label;
        if(typeof research[k]==='number') btn.disabled=true;
        btn.onclick=()=>{ const pre=moveSnapshot; for(const key in g) addRes(key,g[key]); research[k]=val; finalize(pre, val, `ç ”ç©¶ #${k+1}`, [i,j]); };
        slots.appendChild(btn);
      }
      body.appendChild(slots);
      body.appendChild(buildResearchTable());
    }else{
      const opts = val<=5? [ [1,'ind'], [2,'art'] ]
        : val<=10? [ [2,'ind'], [1,'art'] ]
        : val<=15? [ [4,'ind'], [2,'art'] ]
        : val<=20? [ [6,'ind'], [2,'art'] ]
        : [ [8,'ind'], [3,'art'] ];
      const b1=document.createElement('button'); b1.type='button'; b1.textContent=`âš™ +${opts[0][0]}`;
      b1.onclick=()=>{ const pre=moveSnapshot; addRes(opts[0][1], opts[0][0]); finalize(pre, val, 'æ•™è‚² âš™', [i,j]); };
      const b2=document.createElement('button'); b2.type='button'; b2.textContent=`ğŸ–‹ +${opts[1][0]}`;
      b2.onclick=()=>{ const pre=moveSnapshot; addRes(opts[1][1], opts[1][0]); finalize(pre, val, 'æ•™è‚² ğŸ–‹', [i,j]); };
      body.append('ã©ã¡ã‚‰ã‹ç²å¾—ï¼š ',b1,b2);
    }
  }
  renderBody();
  actionDlg.showModal();
}

/* é–‹æ‹“ï¼šã‚°ãƒ¬ãƒ¼ã¸ã®æ›¸ãè¾¼ã¿ */
function enableGreyWrite(devNum, baselineSource, flashCellIJ, preSnap, fromTxt, toTxt){
  pendingGrey = { devNum, baselineSource, flashCellIJ, preSnap, fromTxt, toTxt };
  pendingHint.innerHTML = 'ï¼ˆé–‹æ‹“ä¸­ï¼šã‚°ãƒ¬ãƒ¼ãƒã‚¹ã‚’1ã¤ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ•°å­—ã‚’ç½®ã„ã¦ãã ã•ã„ï¼‰';
}
board.addEventListener('click', (e)=>{
  if(!pendingGrey) return;
  const c = e.target.closest('.cell'); if(!c || !c.classList.contains('grey')) return; if(c.dataset.value) return;
  const i=+c.dataset.i, j=+c.dataset.j;
  const pre=pendingGrey.preSnap;
  c.dataset.value=String(pendingGrey.devNum); c.textContent=String(pendingGrey.devNum);
  const g = greyGain(i,j); for(const key in g) addRes(key,g[key]);
  const baseBefore=baseline; updateBaseline(pendingGrey.baselineSource);
  snapshotStack.push(pre);
  turnEl.textContent=String(path.length);
  pendingHint.textContent=''; const f=pendingGrey.flashCellIJ; const fromTxt=pendingGrey.fromTxt, toTxt=pendingGrey.toTxt; pendingGrey=null;
  renderResearch(); renderFrontier(); renderBaselineBar(); updateCityAndEra(); renderTracker();
  if(f) flashCell(f[0],f[1]);
  addHistory({turn:path.length, from:fromTxt||'?', to:toTxt||'?', action:`é–‹æ‹“ â†’ [${i+1},${j+1}]`, baseBefore, baseAfter:baseline, delta:''});
});

/* ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆEscã‚‚ï¼‰ */
btnUndo.addEventListener('click', (e)=>{ e.preventDefault(); undoLastPick(); });
actionDlg.addEventListener('cancel', (e)=>{ e.preventDefault(); undoLastPick(); });
document.getElementById('undoBtn').addEventListener('click', undoLastConfirmed);

/* å¾—ç‚¹è¨ˆç®—ï¼‹æ–‡æ˜è©•ä¾¡ï¼‹ç´™å¹é›ª */
function calcScienceFromResearch(){
  let total = 0, run = 0, prev = null;
  for(let i=0;i<12;i++){
    const v = (typeof research[i]==='number')? research[i] : null;
    if(v===null){ if(run>0){ total += triangular(run); run=0; prev=null; } continue; }
    if(prev!==null && v>prev){ run += 1; } else { if(run>0) total += triangular(run); run = 1; }
    prev = v;
  }
  if(run>0) total += triangular(run);
  return total;
}
function naturalScore(){ const all=new Set(frontierNumbers); frontierX.forEach(n=>all.delete(n)); return all.size; }
function compScore(){
  const sciEnd = calcScienceFromResearch();
  const my = { sci: res.sci + sciEnd, ind: res.ind, dip: res.dip, art: res.art };
  if(compSel.value==='solo'){ return (my.sci>=25) + (my.ind>=25) + (my.dip>=14) + (my.art>=15); }
  const L = { sci:+r('L_sci').value||0, ind:+r('L_ind').value||0, dip:+r('L_dip').value||0, art:+r('L_art').value||0 };
  const R = { sci:+r('R_sci').value||0, ind:+r('R_ind').value||0, dip:+r('R_dip').value||0, art:+r('R_art').value||0 };
  let pts=0; ['sci','ind','dip','art'].forEach(k=>{ if(my[k]>=L[k]) pts++; if(my[k]>=R[k]) pts++; }); return pts;
}
function ratingInfo(total){
  if (total < 20) return { title:'çŸ¥ã‚‰ã‚Œã–ã‚‹å°æ–‡æ˜', emoji:'ğŸº',  sub:'æ­´å²ã®ç‰‡éš…ã§é™ã‹ã«æ¯ã¥ã„ãŸæ–‡æ˜ã€‚æ¬¡ã¯ã‚‚ã†ä¸€æ­©ï¼' };
  if (total < 25) return { title:'ãã‚Œãªã‚Šã®æ–‡æ˜',   emoji:'ğŸ›ï¸', sub:'äººã€…ã®å–¶ã¿ã¯ç¶šãã€ã„ãã¤ã‹ã®éºç”£ã‚’æ®‹ã—ãŸã€‚' };
  if (total < 30) return { title:'æ­´å²ã«æ®‹ã£ãŸå¤§æ–‡æ˜', emoji:'ğŸ“œâœ¨', sub:'å£®å¤§ãªæ–‡åŒ–ã¯å¾Œä¸–ã¾ã§èªã‚Šç¶™ãŒã‚Œã‚‹ï¼' };
  if (total < 35) return { title:'ä»ŠãªãŠãŠå®¶ç¶šãå‰å¤§ãªæ–‡æ˜', emoji:'ğŸ‘‘ğŸ°', sub:'ç¹æ „ã¯ä»Šã‚‚ç¶šãã€‚å­¦è€…ã‚‚è·äººã‚‚å¤§æ´»èºï¼' };
  return { title:'ã‚„ãŒã¦å®‡å®™ã¸ã¨ç‰ˆå›³ã‚’åºƒã’ã‚‹è¦‡è€…æ–‡æ˜', emoji:'ğŸš€ğŸŒŒ', sub:'æ–‡æ˜ã¯åœ°å¹³ç·šã‚’è¶Šãˆã€æ˜Ÿã€…ã¸ã€‚ã‚ãªãŸãŒæ­´å²ã‚’å¡—ã‚Šæ›¿ãˆãŸï¼' };
}
function makeConfetti(host){
  for(let i=0;i<40;i++){
    const d=document.createElement('div'); d.className='confetti';
    const hue= Math.floor( Math.random()*360 );
    d.style.background=`hsl(${hue} 90% 60%)`;
    d.style.left = (Math.random()*90+5)+'%';
    d.style.top='-10px';
    d.style.transform=`translateY(0) rotate(${Math.random()*180}deg)`;
    d.style.animation = `fall ${800+Math.random()*800}ms ease forwards`;
    host.appendChild(d); setTimeout(()=>d.remove(),1700);
  }
}
function score(){
  const sciEnd = calcScienceFromResearch();
  const invPts = res.inv;
  const cultureMin = Math.min(res.food, res.sci + sciEnd, res.ind);
  const compPts = compScore();
  const nat = naturalScore();
  const total = invPts + cultureMin + compPts + nat;
  const info = ratingInfo(total);
  const out = r('scoreOut');
  out.innerHTML =
    `ğŸ’¡=${invPts}, æ–‡åŒ–(min)=${cultureMin}, ç«¶äº‰=${compPts}, è‡ªç„¶=${nat} â†’ <b>åˆè¨ˆ ${total}</b>` +
    ` <span class="small">ï¼ˆå‚è€ƒ: ğŸ§ª=${res.sci}+${sciEnd}ï¼‰</span>` +
    `<div id="scoreBanner" class="score-banner"><span class="score-badge">${info.emoji}</span><div><div class="score-title">${info.title}</div><div class="score-sub">ã‚ãªãŸã®æ–‡æ˜ã¯ <b>${total} ç‚¹</b>ã€‚${info.sub}</div></div></div>`;
  // ç´™å¹é›ª
  const banner = document.getElementById('scoreBanner');
  makeConfetti(banner);
  updateCityAndEra();
}

/* åˆæœŸåŒ– */
function resetAll(){
  Object.assign(res,{food:0,sci:0,ind:0,art:0,dip:0,inv:0}); Object.assign(stat,{invEarned:0,invSpent:0}); updRes();
  research=[]; frontierX.clear(); usedNumbers=new Set([12]); baseline=12; baselineEl.textContent=baseline;
  pendingGrey=null; pendingHint.textContent=''; moveSnapshot=null; snapshotStack=[]; moveHistory=[];
  buildBoard();
}
buildBoard(); updRes();

document.getElementById('randomFill').onclick=randFill;
document.getElementById('clearNums').onclick=clearNums;
document.getElementById('scoreBtn').onclick=score;
document.getElementById('resetAll').onclick=resetAll;
compSel.addEventListener('change', ()=>{ compPanel.style.display = compSel.value==='multi' ? 'block' : 'none'; });
compPanel.style.display='none';
</script>
</body>
</html>
