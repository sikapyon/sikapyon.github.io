<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Mini Civilization â€“ å¼·åŒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</title>
<style>
  /* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒ†ãƒ¼ãƒ ===== */
  :root{
    /* ç›¤é¢ã‚»ãƒ«ã®ã‚µã‚¤ã‚ºï¼šç”»é¢ã«åˆã‚ã›ã¦è‡ªå‹•ç¸®å° */
    --size: clamp(36px, 7.2vmin, 64px);
    --gap: 8px;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; color:#222; background:#0f1527; }
  header{
    padding:10px 12px; background:#0b1327; color:#e9eeff;
    border-bottom:1px solid #1f2b4f; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  h1{ font-size:16px; margin:0 8px 0 0; }
  .pill{ background:#162650; padding:4px 10px; border-radius:999px; font-size:12px; }
  select,button{ font-weight:600; border-radius:8px; border:1px solid #30416f; background:#132049; color:#eaf0ff; padding:7px 10px; }
  button:hover{ background:#1a2b5e }
  .wrap{ padding:14px; max-width:1200px; margin:0 auto; display:grid; gap:14px; }

  /* ===== ã‚«ãƒ¼ãƒ‰ï¼ˆè¦–èªæ€§ã®é«˜ã„â€œæµ®ãâ€ï¼‰ ===== */
  .card{
    background:#0f1a37; border:1px solid #233058; border-radius:14px; padding:14px;
    box-shadow:0 10px 26px rgba(0,0,0,.25);
  }
  .section{ margin-top:18px } /* â† ç¸¦ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
  .title{ font-weight:800; color:#cfe0ff; margin-bottom:6px; }

  /* ===== ç›¤é¢ï¼‹æ•™è‚²ã‚’ä¸€æšã«ã¾ã¨ã‚ã¦å¸¸æ™‚è¦–ç•Œ ===== */
  .topGrid{
    display:grid; gap:14px;
    /* ç›¤é¢ã®æ¨ªæ¯”ç‡ã‚’å„ªå…ˆã—ã¤ã¤ã€æ•™è‚²ã‚‚å¿…ãšå…¥ã‚‹ã‚ˆã†2è¡Œæ§‹æˆ */
    grid-template-columns: 1fr;
    grid-template-rows: auto auto;
  }
  .boardWrap{ position:relative; margin-inline:auto; }
  .grid{ display:grid; grid-template-columns:repeat(5,var(--size)); grid-auto-rows:var(--size); gap:var(--gap); }
  .cell{
    display:grid; place-items:center; font-size:22px; user-select:none;
    border-radius:12px; color:#eef2ff;
    background:#152554; box-shadow:0 0 0 1px #33406d inset; transition:transform .12s, box-shadow .25s;
  }
  .white{ background:#152554 } .grey{ background:#23305a }
  .cell.pulse{ animation:pulse .25s } @keyframes pulse{ 50%{ transform:scale(1.06) } }
  .cell.flash{ box-shadow:0 0 0 3px #8cb0ff inset; animation:flashOut .6s } @keyframes flashOut{ to{ box-shadow:0 0 0 1px #33406d inset } }
  .cell.chosen{ outline:2px solid #7ea1ff }

  svg.lines{ position:absolute; inset:0; pointer-events:none }
  .seg-draw{ stroke-dasharray:var(--len); stroke-dashoffset:var(--len); animation:draw .35s ease forwards }
  @keyframes draw{ to{ stroke-dashoffset:0 } }
  .spark{ fill:#ffd54a; opacity:0; animation:spark .55s } @keyframes spark{ 0%{opacity:0;transform:scale(.5)} 40%{opacity:1} 100%{opacity:0;transform:scale(1.5)} }

  /* ===== æ•™è‚²ã‚«ãƒ¼ãƒ‰ï¼ˆç›¤é¢ã¨åŒã‚«ãƒ¼ãƒ‰å†…ï¼‰ ===== */
  .eduGrid{ display:grid; grid-template-columns:repeat(5,minmax(120px,1fr)); gap:10px; }
  .eduCard{
    background:#0f1a37; border:1px solid #2c3a61; border-radius:12px; padding:10px; text-align:center;
    box-shadow:0 2px 10px rgba(0,0,0,.25); transition:transform .15s, box-shadow .15s, border-color .15s;
  }
  .eduCard.active{ transform:translateY(-2px); border-color:#6a8cff; box-shadow:0 6px 16px rgba(106,140,255,.28) }
  .eduRange{ font-weight:800; color:#cfe0ff; margin-bottom:6px }
  .eduGain{ display:flex; justify-content:center; gap:10px; color:#e9eeff; font-weight:700 }

  /* ===== åŸºæº–ã¨ã‚»ãƒ¬ã‚¯ã‚¿ ===== */
  .bar{ margin-top:6px; color:#b7c3ff; font-family:ui-monospace,Consolas,monospace }
  #numSelector{ margin-top:8px; display:grid; grid-template-columns:repeat(25, 26px); gap:6px; justify-content:center }
  .numdot{ width:26px; height:26px; border-radius:999px; display:grid; place-items:center; font-size:12px;
           background:#162650; color:#dbe5ff; border:2px solid #445a9a }
  .numdot.used{ background:#445a9a; color:#fff }
  .numdot.current{ outline:3px solid #ffcc66 }

  /* ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé–“éš”ã‚’åºƒã‚ã«ï¼‰ ===== */
  .resRow{ display:flex; flex-wrap:wrap; gap:12px; margin-bottom:10px }
  .resBadge{ background:#182550; border:1px solid #2c3a61; color:#eaf0ff; border-radius:10px; padding:6px 9px }

  /* ===== ç¸¦ä¸¦ã³ãƒˆãƒ©ãƒƒã‚«ãƒ¼ ===== */
  .tracksBox{ display:flex; gap:24px; flex-wrap:wrap; margin-top:10px }
  .trackcol > b{ display:block; color:#cfe0ff; margin-bottom:6px }
  .ticks.stack{ display:grid; grid-auto-flow:column; grid-auto-columns:min-content; grid-template-rows: repeat(var(--rows), 18px); gap:4px 8px }
  .tick{ width:16px; height:16px; border:1px solid #2d3a61; background:#152554; border-radius:3px }
  .tick.filled{ background:#7fb2ff } .tick.checked{ background:#7fb2ff; box-shadow:inset 0 0 0 2px #0f1a37 }

  /* ===== ç™ºæ˜ï¼ˆæœªä½¿ç”¨/ä½¿ç”¨æ¸ˆã¿ã‚’æ˜ç¢ºåŒ–ï¼‰ ===== */
  .invRow{ display:flex; gap:8px; align-items:center }
  .inv-bulb{ position:relative; width:24px; height:24px; border-radius:6px; display:grid; place-items:center;
             background:#fff7cc; color:#332b00; border:1px solid #e8d067; font-size:16px }
  .inv-bulb.used{ background:#1f2b4f; color:#a2adcf; border-color:#2c3a61; }
  .inv-bulb.used::after{
    content:"/"; position:absolute; inset:0; display:grid; place-items:center;
    color:#a2adcf; font-weight:900; font-size:18px; transform:scale(1.2);
  }
  .invLabel{ color:#cfe0ff; font-weight:700 }

  /* ===== é–‹æ‹“UIï¼ˆ9ãƒãƒƒãƒ—ï¼‰ ===== */
  .frontRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
  .fchip{
    display:inline-flex; align-items:center; justify-content:center; padding:4px 8px; border-radius:999px;
    background:#162650; color:#eaf0ff; border:1px solid #2c3a61; font-weight:700; min-width:42px;
  }
  .fchip.done{ background:#1b2446; color:#93a1d8; position:relative }
  .fchip.done::after{
    content:"Ã—"; position:absolute; inset:0; display:grid; place-items:center; color:#93a1d8; font-weight:900;
  }
  .fchip.pick{ outline:2px solid #6a8cff }

  /* ===== ç ”ç©¶ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤º ===== */
  .slot{ display:inline-flex; align-items:center; gap:6px; border:1px dashed #30416f; border-radius:8px; padding:4px 6px; margin:4px; color:#dce5ff }
  .tbl{ border-collapse:collapse; margin-top:8px; width:100% }
  .tbl th,.tbl td{ border:1px solid #2c3a61; padding:4px 6px; text-align:center; color:#e9eeff }
  .tbl th{ background:#1b2a59 }

  /* ===== UNDOå±¥æ­´ï¼ˆã‚«ãƒ¼ãƒ‰é¢¨ï¼‰ ===== */
  #historyList{ display:flex; flex-direction:column; gap:8px; max-height:230px; overflow:auto }
  .hist{ background:#ffffff; color:#111; border:1px solid #2f3545; border-radius:12px; padding:6px 10px; box-shadow:0 6px 18px rgba(0,0,0,.18) }
  .hist b{ color:#111 }

  /* ===== ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ===== */
  dialog{ border:1px solid #ccd3ee; border-radius:12px; padding:12px 14px }
  dialog::backdrop{ background:rgba(0,0,0,.25) }
  .mono{ font-family:ui-monospace,SFMono-Regular,Consolas,monospace; }

  /* ã‚¹ãƒãƒ›å¹…æœ€é©åŒ– */
  @media (max-width:920px){
    .eduGrid{ grid-template-columns:repeat(5, minmax(92px,1fr)); }
  }
</style>
</head>
<body>
<header>
  <h1>Mini Mini Civilization â€“ ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆ</h1>
  <span class="pill">åŸºæº–å€¤: <span id="baseline">12</span></span>
  <span class="pill">æ‰‹æ•°: <span id="turn">0</span>/25</span>
  <label class="pill">åŸºæº–æ–¹å¼:
    <select id="mode"><option value="solo">å…¬å¼ã‚½ãƒ­ï¼ˆè¿‘å‚ã¸è‡ªå‹•ï¼‰</option><option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option></select>
  </label>
  <label class="pill">ç«¶äº‰:
    <select id="compMode"><option value="solo">ã‚½ãƒ­ï¼ˆé–¾å€¤æ¯”è¼ƒï¼‰</option><option value="multi">2äººä»¥ä¸Šï¼ˆå·¦å³æ¯”è¼ƒï¼‰</option></select>
  </label>
  <button id="resetAll">å…¨é¢ãƒªã‚»ãƒƒãƒˆ</button>
</header>

<div class="wrap">

  <!-- ===== ç›¤é¢ï¼‹æ•™è‚²ï¼ˆå¸¸æ™‚è¦–ç•Œï¼‰ ===== -->
  <section class="card">
    <div class="title">ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ ï¼† æ•™è‚²ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰</div>
    <div class="topGrid">
      <div class="boardWrap">
        <div id="board" class="grid" aria-label="5x5 board"></div>
        <svg id="lines" class="lines"></svg>
        <div class="bar" id="binfo"></div>
        <div id="numSelector"></div>
        <div class="bar"><b>ç™ºå±•åº¦:</b> <span id="cityRow"></span></div>
        <div class="bar small">1æ‰‹ç›®ã¯è‡ªç”±ã€ä»¥é™ã¯<strong>éš£æ¥8æ–¹å‘</strong>ã®ã¿ã€‚æœªè¨˜å…¥ãƒã‚¹ï¼ˆç™½/ç°ï¼‰ã‚’é¸ã¶ã¨è‡ªå‹•ã§ã€Œ1ã€ã‚’æ›¸ãè¾¼ã¿ã€ãã®æ•°ã§åˆ¤å®šï¼ˆè³‡æºãªã—ï¼‰ã€‚<span id="pendingHint"></span></div>
      </div>

      <div class="section">
        <div class="title">æ•™è‚²ï¼ˆåŸºæº–ä»¥ä¸‹ï¼‰</div>
        <div class="eduGrid">
          <div class="eduCard" data-range="1-5"><div class="eduRange">1â€“5</div><div class="eduGain">âš™+1 / ğŸ–‹+2</div></div>
          <div class="eduCard" data-range="6-10"><div class="eduRange">6â€“10</div><div class="eduGain">âš™+2 / ğŸ–‹+1</div></div>
          <div class="eduCard" data-range="11-15"><div class="eduRange">11â€“15</div><div class="eduGain">âš™+4 / ğŸ–‹+2</div></div>
          <div class="eduCard" data-range="16-20"><div class="eduRange">16â€“20</div><div class="eduGain">âš™+6 / ğŸ–‹+2</div></div>
          <div class="eduCard" data-range="21-25"><div class="eduRange">21â€“25</div><div class="eduGain">âš™+8 / ğŸ–‹+3</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ===== -->
  <section class="card">
    <div class="title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>

    <div class="resRow">
      <div class="resBadge">ğŸ é£Ÿæ–™: <b id="rFood">0</b></div>
      <div class="resBadge">ğŸ§ª ç§‘å­¦: <b id="rSci">0</b></div>
      <div class="resBadge">âš™ ç”£æ¥­: <b id="rInd">0</b></div>
      <div class="resBadge">ğŸ–‹ èŠ¸è¡“: <b id="rArt">0</b></div>
      <div class="resBadge">ğŸ‘ å¤–äº¤: <b id="rDip">0</b></div>
      <div class="resBadge">ğŸ’¡ ç™ºæ˜(æœªä½¿ç”¨): <b id="rInv">0</b></div>
    </div>

    <!-- ç¸¦ã‚¹ã‚¿ãƒƒã‚¯ã®è¦‹ã‚„ã™ã„ãƒˆãƒ©ãƒƒã‚«ãƒ¼ -->
    <div id="tracks" class="tracksBox"></div>

    <!-- é–‹æ‹“ï¼ˆãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–ï¼‰ -->
    <div class="section">
      <div class="title">é–‹æ‹“ï¼ˆå¥‡æ•°ã‹ã¤åŸºæº–ã‚ˆã‚Šå¤§ï¼‰</div>
      <div id="frontierRow" class="frontRow" aria-label="frontier chips"></div>
      <div class="bar small">æº€æ¯ãªã‚‰ğŸ+1ï¼ˆæ•‘æ¸ˆï¼‰ã€‚</div>
    </div>

    <!-- ç ”ç©¶ -->
    <div class="section">
      <div class="title">ç ”ç©¶ï¼ˆå¶æ•°ã‹ã¤åŸºæº–ã‚ˆã‚Šå¤§ï¼‰</div>
      <div id="researchSlots" class="small"></div>
      <div id="researchTableWrap"></div>
      <div class="bar small">çµ‚äº†æ™‚è¨ˆç®—ï¼š<b>å·¦â†’å³ã§å¢—ãˆç¶šã‘ã‚‹</b>é€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸‰è§’æ•°ï¼ˆ1/3/6/10/15/21â€¦ï¼‰ã‚’åŠ ç®—ã€‚</div>
    </div>

    <!-- ç™ºæ˜ï¼ˆè¦–èªæ€§å¼·åŒ–ï¼‰ -->
    <div class="section">
      <div class="title">ç™ºæ˜</div>
      <div class="invRow">
        <span class="invLabel">ç²å¾—:</span><span id="invTotal"></span>
        <span class="invLabel">æœªä½¿ç”¨:</span><span id="invRemain"></span>
      </div>
    </div>
  </section>

  <!-- ===== UNDO/å¾—ç‚¹ ===== -->
  <section class="card">
    <div class="title">UNDOå±¥æ­´</div>
    <div id="historyList"></div>
    <div class="section">
      <div class="title">å¾—ç‚¹è¨ˆç®—</div>
      <div class="resRow">
        <button id="undoBtn">â†© ä¸€æ‰‹æˆ»ã™</button>
        <button id="scoreBtn">å¾—ç‚¹è¨ˆç®—</button>
        <button id="clearNums">æ•°å­—ã‚¯ãƒªã‚¢</button>
        <button id="randomFill">5â€“20ã‚’ãƒ©ãƒ³ãƒ€ãƒ é…ç½®</button>
      </div>
      <div id="scoreOut" class="bar">ã‚½ãƒ­é–¾å€¤ï¼šğŸ§ª25, âš™25, ğŸ‘<b>15</b>, ğŸ–‹<b>14</b>ã€‚æœªä½¿ç”¨ğŸ’¡Ã—1ã€min(ğŸ,ğŸ§ª+ç ”ç©¶,âš™)ã‚’åŠ ç®—ã€‚è‡ªç„¶=é–‹æ‹“æœªÃ—ã®æ•°ã€‚</div>
    </div>
  </section>

</div>

<!-- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼šç¢ºå®šãªã—ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼UNDOï¼‰ -->
<dialog id="actionDlg">
  <form method="dialog">
    <div class="title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div id="actionInfo" class="mono"></div>
    <div id="actionBody" class="section"></div>
    <div style="display:flex;gap:6px;margin-top:8px;">
      <button id="btnUndo" value="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã“ã®æ‰‹ã‚’å–ã‚Šæ¶ˆã™ï¼‰</button>
    </div>
  </form>
</dialog>

<script>
/* ===== å‚ç…§ ===== */
const board = document.getElementById('board');
const lines = document.getElementById('lines');
const baselineEl = document.getElementById('baseline');
const turnEl = document.getElementById('turn');
const actionDlg = document.getElementById('actionDlg');
const actionInfo = document.getElementById('actionInfo');
const actionBody = document.getElementById('actionBody');
const btnUndo = document.getElementById('btnUndo');
const binfo = document.getElementById('binfo');
const cityRow = document.getElementById('cityRow');
const numSelector = document.getElementById('numSelector');
const modeSel = document.getElementById('mode');
const pendingHint = document.getElementById('pendingHint');
const historyList = document.getElementById('historyList');
const researchSlots = document.getElementById('researchSlots');
const researchTableWrap = document.getElementById('researchTableWrap');
const frontierRow = document.getElementById('frontierRow');
const tracks = document.getElementById('tracks');
const r = id=>document.getElementById(id);

/* ===== ãƒªã‚½ãƒ¼ã‚¹ ===== */
const res = { food:0, sci:0, ind:0, art:0, dip:0, inv:0 };
const stat = { invEarned:0, invSpent:0 };
function updRes(){
  r('rFood').textContent=res.food; r('rSci').textContent=res.sci; r('rInd').textContent=res.ind;
  r('rArt').textContent=res.art; r('rDip').textContent=res.dip; r('rInv').textContent=res.inv;
  renderTracks(); renderInv();
}
function popGain(key, amt){ /* ç°¡æ˜“ãƒãƒƒãƒ—çœç•¥ï¼ˆæ—¢å­˜ã®ã¾ã¾ã§ã‚‚OKï¼‰ */ }
function addRes(key, amt){
  res[key]+=amt; if(key==='dip'){ const g=Math.floor(res.dip/5)-Math.floor((res.dip-amt)/5); if(g>0){ addRes('art',g); } }
  if(key==='art'){ const g=Math.floor(res.art/4)-Math.floor((res.art-amt)/4); if(g>0){ stat.invEarned+=g; addRes('inv',g); } }
  updRes();
}

/* ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ===== */
let cells=[], path=[], baseline=12, usedNumbers=new Set([12]);
const frontierNumbers=[21,1,22,2,23,3,24,4,25];
let frontierX=new Set();
let research=[]; // 12 slots
let pendingGrey=null; let moveSnapshot=null; let snapshotStack=[]; let moveHistory=[];
let lastPicked=0;

/* å¹¾ä½• */
function triangular(n){ return n*(n+1)/2 }
function inB(i,j){ return i>=0&&i<5&&j>=0&&j<5 }
function nb(i,j){ const a=[]; for(let di=-1;di<=1;di++)for(let dj=-1;dj<=1;dj++){ if(di||dj){ const ni=i+di,nj=j+dj; if(inB(ni,nj)) a.push([ni,nj]); } } return a }
function cellCenter([i,j]){ const s=parseFloat(getComputedStyle(board).getPropertyValue('--size')); const g=parseFloat(getComputedStyle(board).getPropertyValue('--gap')); return {x:j*(s+g)+s/2, y:i*(s+g)+s/2} }
function segLen(ax,ay,bx,by){ const dx=bx-ax, dy=by-ay; return Math.hypot(dx,dy) }
function segInt(a,b,c,d){ function cr(x1,y1,x2,y2,x3,y3){ return (x2-x1)*(y3-y1)-(y2-y1)*(x3-x1) } const A=cr(a.x,a.y,b.x,b.y,c.x,c.y), B=cr(a.x,a.y,b.x,b.y,d.x,d.y), C=cr(c.x,c.y,d.x,d.y,a.x,a.y), D=cr(c.x,c.y,d.x,d.y,b.x,b.y); return (A*B<0 && C*D<0) }
function addSpark(x,y){ const s=document.createElementNS('http://www.w3.org/2000/svg','circle'); s.setAttribute('cx',x); s.setAttribute('cy',y); s.setAttribute('r',6); s.setAttribute('class','spark'); lines.appendChild(s); setTimeout(()=>s.remove(),600) }

/* ã‚°ãƒ¬ãƒ¼é…åˆ—ãƒ»è³‡æº */
const greyMap=[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]];
function greyGain(i,j){ const cor=(i===0&&j===0)||(i===0&&j===4)||(i===4&&j===0)||(i===4&&j===4); const cen=(i===2&&j===2); if(cen) return {food:2,dip:2}; if(cor) return {food:4,dip:1}; return {food:3,dip:1} }

/* ç ”ç©¶ã‚¹ãƒ­ãƒƒãƒˆè³‡æº */
const researchGain=[{art:1,dip:1},{sci:1,dip:1},{sci:1,dip:1},{dip:2},{dip:1},{food:1,dip:1},{food:1,dip:1},{dip:1},{dip:2},{sci:1,dip:1},{sci:1,dip:1},{art:1,dip:1}];

/* ç›¤é¢ */
function buildBoard(){
  board.innerHTML=''; lines.innerHTML=''; cells=[]; path=[]; baseline=12; usedNumbers=new Set([12]);
  frontierX.clear(); research=[]; pendingGrey=null; moveSnapshot=null; snapshotStack=[]; moveHistory=[]; renderHistory();
  baselineEl.textContent=baseline; turnEl.textContent='0'; lastPicked=0; highlightEducation(0);
  for(let i=0;i<5;i++){ cells[i]=[]; for(let j=0;j<5;j++){ const d=document.createElement('div'); d.className='cell '+(greyMap[i][j]?'grey':'white'); d.dataset.i=i; d.dataset.j=j; d.dataset.value=''; d.onclick=()=>onPick(i,j); board.appendChild(d); cells[i][j]=d; } }
  fitSVG(false); renderBaselineBar(); renderFrontier(); renderResearch(); renderTracks(); renderInv();
}
function randFill(){ const nums=[]; for(let n=5;n<=20;n++) nums.push(n); for(let k=nums.length-1;k>0;k--){ const j=Math.floor(Math.random()*(k+1)); [nums[k],nums[j]]=[nums[j],nums[k]] } let idx=0; for(let i=0;i<5;i++)for(let j=0;j<5;j++){ const c=cells[i][j]; if(c.classList.contains('white')){ c.dataset.value=c.textContent=String(nums[idx++]); } else { c.dataset.value=c.textContent='' } } }
function clearNums(){ for(const row of cells) for(const c of row){ if(c.classList.contains('white')){ c.dataset.value=c.textContent='' } } }

function fitSVG(ani=false){
  const rect=board.getBoundingClientRect(); lines.setAttribute('viewBox',`0 0 ${rect.width} ${rect.height}`); lines.innerHTML='';
  if(path.length<=1) return;
  const end=path.length-1;
  for(let k=1;k<end;k++){ const a=cellCenter(path[k-1]), b=cellCenter(path[k]); const L=document.createElementNS('http://www.w3.org/2000/svg','line'); L.setAttribute('x1',a.x); L.setAttribute('y1',a.y); L.setAttribute('x2',b.x); L.setAttribute('y2',b.y); L.setAttribute('stroke','#6a8cff'); L.setAttribute('stroke-width','3'); lines.appendChild(L); }
  const a=cellCenter(path[end-1]), b=cellCenter(path[end]); const L=document.createElementNS('http://www.w3.org/2000/svg','line'); L.setAttribute('x1',a.x); L.setAttribute('y1',a.y); L.setAttribute('x2',b.x); L.setAttribute('y2',b.y); L.setAttribute('stroke','#6a8cff'); L.setAttribute('stroke-width','3'); if(ani){ const len=segLen(a.x,a.y,b.x,b.y); L.classList.add('seg-draw'); L.style.setProperty('--len',len) } lines.appendChild(L);
  for(let k=1;k<end-1;k++){ const p1=cellCenter(path[k-1]), p2=cellCenter(path[k]); if(segInt(p1,p2,a,b)) addSpark((p1.x+p2.x)/2,(p1.y+p2.y)/2); }
}
addEventListener('resize',()=>fitSVG(false));

/* åŸºæº–ãƒãƒ¼ï¼†ã‚»ãƒ¬ã‚¯ã‚¿ */
function renderBaselineBar(){
  const remain=[]; for(let n=1;n<=25;n++) if(!usedNumbers.has(n)) remain.push(n);
  binfo.innerHTML = `åŸºæº–: <b>${baseline}</b>ã€€ä½¿ç”¨: ${usedNumbers.size}/25ã€€æ®‹ã‚Š: ${remain.join(', ')||'ãªã—'}`;
  numSelector.innerHTML=''; for(let n=1;n<=25;n++){ const d=document.createElement('div'); d.className='numdot'; if(usedNumbers.has(n)) d.classList.add('used'); if(n===baseline) d.classList.add('current'); d.textContent=n; numSelector.appendChild(d); }
}
function updateCityAndEra(){
  const sciEnd = calcScienceFromResearch();
  const cultureMin = Math.min(res.food, res.sci + sciEnd, res.ind);
  const total = res.inv + cultureMin;
  const steps=[5,10,15,20,25,30,35]; const icons=['ğŸ ','ğŸ˜ï¸','ğŸ›ï¸','ğŸ¯','ğŸ°','ğŸ™ï¸','ğŸš€']; let built=0; for(const t of steps){ if(total>=t) built++; }
  cityRow.textContent = icons.slice(0,built).join(' ');
}

/* ç ”ç©¶è¡¨ç¤º */
function buildResearchTable(){
  const tbl=document.createElement('table'); tbl.className='tbl';
  const trh=document.createElement('tr'); for(let i=1;i<=12;i++){ const th=document.createElement('th'); th.textContent='#'+i; trh.appendChild(th) }
  const trb=document.createElement('tr'); for(let i=0;i<12;i++){ const td=document.createElement('td'); td.textContent=(typeof research[i]==='number')?research[i]:'ç©º'; trb.appendChild(td) }
  tbl.append(trh,trb); return tbl;
}
function renderResearch(){
  researchSlots.innerHTML='';
  const row=document.createElement('div');
  for(let i=0;i<12;i++){
    const g=researchGain[i]; const show=(typeof research[i]==='number')?`ã€${research[i]}ã€‘`:'ç©º';
    const lab=(typeof research[i]==='number')?`#${i+1} ${show}`:`#${i+1} ${Object.entries(g).map(([k,v])=>({food:'ğŸ',sci:'ğŸ§ª',ind:'âš™',art:'ğŸ–‹',dip:'ğŸ‘'}[k])+`+${v}`).join(' ')} ã«æ›¸ãï¼ˆç©ºï¼‰`;
    const s=document.createElement('span'); s.className='slot'; s.textContent=lab; row.appendChild(s);
  }
  researchSlots.appendChild(row);
  researchTableWrap.innerHTML=''; researchTableWrap.appendChild(buildResearchTable());
}

/* ç¸¦ãƒˆãƒ©ãƒƒã‚¯ï¼†ç™ºæ˜è¡Œ */
function ticksStack(container, count, group, rows){
  container.style.setProperty('--rows', rows);
  const full=Math.floor(count/group), rest=count%group;
  for(let g=0;g<full;g++){ for(let k=0;k<group;k++){ const t=document.createElement('div'); t.className='tick checked'; container.appendChild(t) } }
  for(let k=0;k<rest;k++){ const t=document.createElement('div'); t.className='tick filled'; container.appendChild(t) }
  for(let k=rest;k<group;k++){ const t=document.createElement('div'); t.className='tick'; container.appendChild(t) }
}
function renderTracks(){
  tracks.innerHTML='';
  const dip=document.createElement('div'); dip.className='trackcol'; dip.innerHTML='<b>ğŸ‘ å¤–äº¤</b>'; const dt=document.createElement('div'); dt.className='ticks stack'; ticksStack(dt,res.dip,5,5); dip.appendChild(dt); tracks.appendChild(dip);
  const art=document.createElement('div'); art.className='trackcol'; art.innerHTML='<b>ğŸ–‹ èŠ¸è¡“</b>'; const at=document.createElement('div'); at.className='ticks stack'; ticksStack(at,res.art,4,4); art.appendChild(at); tracks.appendChild(art);
}
function renderInv(){
  const total = stat.invEarned;
  const remain = res.inv;
  const used = Math.max(0, total - remain);
  const totalWrap = document.getElementById('invTotal'); totalWrap.innerHTML='';
  const remainWrap = document.getElementById('invRemain'); remainWrap.innerHTML='';
  for(let i=0;i<total;i++){ const b=document.createElement('div'); b.className='inv-bulb'; b.textContent='ğŸ’¡'; if(i<used) b.classList.add('used'); totalWrap.appendChild(b); }
  for(let i=0;i<remain;i++){ const b=document.createElement('div'); b.className='inv-bulb'; b.textContent='ğŸ’¡'; remainWrap.appendChild(b); }
}

/* é–‹æ‹“ãƒãƒƒãƒ— */
function renderFrontier(){
  frontierRow.innerHTML='';
  frontierNumbers.forEach(n=>{
    const b=document.createElement('div'); b.className='fchip'; b.textContent=n;
    if(frontierX.has(n)) b.classList.add('done');
    frontierRow.appendChild(b);
  });
}

/* ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ */
function serializeBoard(){ const vals=[], chosen=[]; for(let i=0;i<5;i++){ vals[i]=[]; chosen[i]=[]; for(let j=0;j<5;j++){ const c=cells[i][j]; vals[i][j]=c.dataset.value||''; chosen[i][j]=c.classList.contains('chosen'); } } return {vals,chosen,path:JSON.parse(JSON.stringify(path))} }
function applyBoard(state, ani=false){ for(let i=0;i<5;i++)for(let j=0;j<5;j++){ const c=cells[i][j]; c.dataset.value=state.vals[i][j]; c.textContent=state.vals[i][j]; c.classList.toggle('chosen',!!state.chosen[i][j]); } path=JSON.parse(JSON.stringify(state.path)); fitSVG(ani) }
function snap(){ return { baseline, used:new Set(usedNumbers), res:{...res}, stat:{...stat}, research:research.slice(), frontierX:new Set(frontierX), board:serializeBoard() } }
function restore(s){ Object.assign(res,s.res); Object.assign(stat,s.stat); updRes(); research=s.research.slice(); frontierX=new Set(s.frontierX); baseline=s.baseline; baselineEl.textContent=baseline; usedNumbers=new Set(s.used); applyBoard(s.board,false); renderBaselineBar(); renderFrontier(); renderResearch(); updateCityAndEra(); }
function undoPick(){ if(!moveSnapshot) return; restore(moveSnapshot); moveSnapshot=null; pendingGrey=null; pendingHint.textContent=''; lastPicked=0; actionDlg.close(); }
function undoStep(){ if(snapshotStack.length===0) return; restore(snapshotStack.pop()); moveHistory.pop(); renderHistory(); turnEl.textContent=String(path.length); }

/* å±¥æ­´ */
function addHist(h){ moveHistory.push(h); renderHistory() }
function renderHistory(){ historyList.innerHTML=''; moveHistory.forEach(h=>{ const d=document.createElement('div'); d.className='hist'; d.innerHTML=`<b>${h.turn}.</b> ${h.from}â†’${h.to} / ${h.action} <span class="mono">åŸºæº– ${h.baseBefore}â†’${h.baseAfter}</span>`; historyList.appendChild(d) }) }

/* æ•™è‚²ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
function highlightEducation(v){ document.querySelectorAll('.eduCard').forEach(c=>{ const [a,b]=c.dataset.range.split('-').map(Number); c.classList.toggle('active', v>=a && v<=b); }) }

/* åŸºæº–æ›´æ–° */
function updateBaseline(lastVal){
  const mode=modeSel.value;
  if(mode==='random'){
    const pool=[]; for(let n=1;n<=25;n++) if(!usedNumbers.has(n)) pool.push(n);
    if(pool.length>0) baseline = pool[Math.floor(Math.random()*pool.length)];
  }else{
    const greater= lastVal>baseline; const dir=greater?1:-1; let cand=lastVal+dir;
    while(cand>=1&&cand<=25&&usedNumbers.has(cand)) cand+=dir;
    if(cand<1||cand>25){ cand=lastVal-dir; while(cand>=1&&cand<=25&&usedNumbers.has(cand)) cand-=dir; }
    if(cand>=1&&cand<=25) baseline=cand;
  }
  usedNumbers.add(baseline); baselineEl.textContent=baseline; renderBaselineBar();
}

/* ã‚¯ãƒªãƒƒã‚¯ */
function onPick(i,j){
  if(pendingGrey) return;
  const c=cells[i][j];
  if(path.length){ const [pi,pj]=path[path.length-1]; if(!nb(pi,pj).some(([ni,nj])=>ni===i&&nj===j)) return; }
  if(c.classList.contains('chosen')) return;

  moveSnapshot=snap();                      // â† äº‹å‰ä¿å­˜
  if(!c.dataset.value){ c.dataset.value='1'; c.textContent='1'; } // ç©ºã¯1ï¼ˆè³‡æºãªã—ï¼‰
  const val=Number(c.dataset.value); lastPicked=val; highlightEducation(val);
  c.classList.add('chosen','pulse'); setTimeout(()=>c.classList.remove('pulse'),250);
  path.push([i,j]); fitSVG(true);

  const gt = val>baseline; const parity = val%2===0?'even':'odd';
  showAction({i,j,val,gt,parity});
}
function flashCell(i,j){ const c=cells[i][j]; c.classList.add('flash'); setTimeout(()=>c.classList.remove('flash'),520) }
function gainStr(o){ return Object.entries(o).map(([k,v])=>({food:'ğŸ',sci:'ğŸ§ª',ind:'âš™',art:'ğŸ–‹',dip:'ğŸ‘'}[k])+`+${v}`).join(' ') }

function showAction(ctx){
  const {i,j,val,gt,parity}=ctx; let type = gt? (parity==='odd'?'é–‹æ‹“':'ç ”ç©¶') : 'æ•™è‚²';
  const fromTxt = path.length>1? cells[path[path.length-2][0]][path[path.length-2][1]].dataset.value : 'å§‹';
  const toTxt = val;
  actionBody.innerHTML=''; actionInfo.textContent=`é¸ã‚“ã æ•°å­—: ${val} / åŸºæº– ${baseline} â†’ ${gt?'å¤§ãã„':'å°ã•ã„(åŒå€¤å«ã‚€)'}ãƒ»${parity==='odd'?'å¥‡æ•°':'å¶æ•°'} â‡’ ${type}`;

  // ğŸ’¡åè»¢
  const invWrap=document.createElement('div');
  const btnInv=document.createElement('button'); btnInv.textContent='ğŸ’¡1æ¶ˆè²»ã§ä¸Šä¸‹ã‚’åè»¢'; btnInv.disabled=(res.inv<=0);
  let flipped=false; btnInv.onclick=(e)=>{ e.preventDefault(); if(flipped||res.inv<=0) return; flipped=true; res.inv--; stat.invSpent++; updRes(); type=(type==='æ•™è‚²')?(parity==='odd'?'é–‹æ‹“':'ç ”ç©¶'):'æ•™è‚²'; actionInfo.textContent+='ï¼ˆğŸ’¡ä½¿ç”¨ï¼‰'; btnInv.disabled=true; renderBody() };
  invWrap.append('ï¼ˆä»»æ„ï¼‰',btnInv); actionBody.appendChild(invWrap);

  const body=document.createElement('div'); actionBody.appendChild(body);

  function finalize(pre, baseSrc, log, flashIJ){
    snapshotStack.push(pre);
    const baseBefore=baseline; updateBaseline(baseSrc);
    renderResearch(); renderFrontier(); renderBaselineBar(); updateCityAndEra(); updRes();
    if(flashIJ) flashCell(flashIJ[0],flashIJ[1]);
    addHist({turn:path.length, from:fromTxt, to:toTxt, action:log, baseBefore, baseAfter:baseline});
    turnEl.textContent=String(path.length); actionDlg.close(); moveSnapshot=null;
  }

  function renderBody(){
    body.innerHTML='';
    if(type==='é–‹æ‹“'){
      const allDone = frontierNumbers.every(n=>frontierX.has(n));
      if(allDone){
        const p=document.createElement('p'); p.textContent='é–‹æ‹“ãƒˆãƒ©ãƒƒã‚¯ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã™ï¼ˆé–‹æ‹“ä¸å¯ï¼‰ã€‚ğŸ+1ã‚’å¾—ã¾ã™ã€‚';
        const b=document.createElement('button'); b.textContent='ğŸ +1 ã‚’å—ã‘å–ã‚‹'; b.onclick=()=>{ const pre=moveSnapshot; addRes('food',1); finalize(pre,val,'é–‹æ‹“ï¼ˆæº€æ¯æ•‘æ¸ˆï¼‰',[i,j]); }; body.append(p,b); return;
      }
      const p=document.createElement('p'); p.textContent='é–‹æ‹“ç•ªå·ã‚’é¸æŠï¼ˆå·¦å´ã¯Ã—ï¼‰ã€‚ç¶šã„ã¦ä»»æ„ã®ã‚°ãƒ¬ãƒ¼ã¸æ›¸ãè¾¼ã¿ã¾ã™ã€‚'; body.appendChild(p);
      const row=document.createElement('div'); row.className='frontRow';
      frontierNumbers.forEach((n,idx)=>{
        const ch=document.createElement('div'); ch.className='fchip'; ch.textContent=n; if(frontierX.has(n)) ch.classList.add('done');
        ch.onclick=()=>{ if(frontierX.has(n)) return; for(let k=0;k<=idx;k++) frontierX.add(frontierNumbers[k]); enableGreyWrite(n,val,[i,j],moveSnapshot,fromTxt,toTxt); actionDlg.close(); };
        row.appendChild(ch);
      });
      body.appendChild(row);
    }else if(type==='ç ”ç©¶'){
      const p=document.createElement('p'); p.textContent='ç ”ç©¶ã‚¹ãƒ­ãƒƒãƒˆã‚’é¸ã³ã€ä»Šå›ã®æ•°å­—ã‚’æ›¸ãè¾¼ã¿ï¼ˆã‚¹ãƒ­ãƒƒãƒˆè³‡æºã‚‚ç²å¾—ï¼‰'; body.appendChild(p);
      const slots=document.createElement('div'); slots.style.display='flex'; slots.style.flexWrap='wrap'; slots.style.gap='8px';
      for(let k=0;k<12;k++){
        const g=researchGain[k]; const show=(typeof research[k]==='number')?`ã€${research[k]}ã€‘`:'ç©º';
        const lab=(typeof research[k]==='number')?`#${k+1} ${show}`:`#${k+1} ${gainStr(g)} ã«æ›¸ãï¼ˆç©ºï¼‰`;
        const b=document.createElement('button'); b.textContent=lab; if(typeof research[k]==='number') b.disabled=true;
        b.onclick=()=>{ const pre=moveSnapshot; for(const t in g) addRes(t,g[t]); research[k]=val; finalize(pre,val,`ç ”ç©¶ #${k+1}`,[i,j]); };
        slots.appendChild(b);
      }
      body.appendChild(slots); body.appendChild(buildResearchTable());
    }else{
      const opts = val<=5? [ [1,'ind'], [2,'art'] ] : val<=10? [ [2,'ind'], [1,'art'] ] : val<=15? [ [4,'ind'], [2,'art'] ] : val<=20? [ [6,'ind'], [2,'art'] ] : [ [8,'ind'], [3,'art'] ];
      const b1=document.createElement('button'); b1.textContent=`âš™ +${opts[0][0]}`; b1.onclick=()=>{ const pre=moveSnapshot; addRes(opts[0][1],opts[0][0]); finalize(pre,val,'æ•™è‚² âš™',[i,j]); };
      const b2=document.createElement('button'); b2.textContent=`ğŸ–‹ +${opts[1][0]}`; b2.onclick=()=>{ const pre=moveSnapshot; addRes(opts[1][1],opts[1][0]); finalize(pre,val,'æ•™è‚² ğŸ–‹',[i,j]); };
      body.append('ã©ã¡ã‚‰ã‹ç²å¾—ï¼š ',b1,' ',b2);
    }
  }
  renderBody();
  actionDlg.showModal();
}

/* é–‹æ‹“ï¼šã‚°ãƒ¬ãƒ¼ã«æ›¸ãè¾¼ã¿ */
function enableGreyWrite(devNum, baseSrc, flashIJ, pre, fromTxt, toTxt){
  pendingGrey={devNum, baseSrc, flashIJ, pre, fromTxt, toTxt}; pendingHint.textContent='ï¼ˆé–‹æ‹“ä¸­ï¼šã‚°ãƒ¬ãƒ¼ãƒã‚¹ã‚’1ã¤ã‚¯ãƒªãƒƒã‚¯ï¼‰';
}
board.addEventListener('click',(e)=>{
  if(!pendingGrey) return; const c=e.target.closest('.cell'); if(!c||!c.classList.contains('grey')) return; if(c.dataset.value) return;
  const i=+c.dataset.i, j=+c.dataset.j; const pre=pendingGrey.pre;
  c.dataset.value=String(pendingGrey.devNum); c.textContent=String(pendingGrey.devNum);
  const g=greyGain(i,j); for(const k in g) addRes(k,g[k]);
  const before=baseline; updateBaseline(pendingGrey.baseSrc); snapshotStack.push(pre);
  pendingHint.textContent=''; const f=pendingGrey.flashIJ; pendingGrey=null; renderResearch(); renderFrontier(); renderBaselineBar(); updateCityAndEra(); updRes(); if(f) flashCell(f[0],f[1]); addHist({turn:path.length, from:fromTxt||'å§‹', to:toTxt||'?', action:`é–‹æ‹“ â†’ [${i+1},${j+1}]`, baseBefore:before, baseAfter:baseline}); turnEl.textContent=String(path.length);
});

/* ãƒœã‚¿ãƒ³ */
btnUndo.addEventListener('click',(e)=>{ e.preventDefault(); undoPick() });
actionDlg.addEventListener('cancel',(e)=>{ e.preventDefault(); undoPick() });
document.getElementById('undoBtn').onclick=undoStep;
document.getElementById('randomFill').onclick=randFill;
document.getElementById('clearNums').onclick=clearNums;
document.getElementById('resetAll').onclick=()=>{ Object.assign(res,{food:0,sci:0,ind:0,art:0,dip:0,inv:0}); Object.assign(stat,{invEarned:0,invSpent:0}); buildBoard(); updRes(); renderBaselineBar(); };

/* å¾—ç‚¹è¨ˆç®—ï¼ˆğŸ‘15ï¼ğŸ–‹14ï¼‰ */
function calcScienceFromResearch(){ let tot=0, run=0, prev=null; for(let i=0;i<12;i++){ const v=typeof research[i]==='number'?research[i]:null; if(v===null){ if(run>0){ tot+=triangular(run); run=0; prev=null; } continue } if(prev!==null && v>prev){ run+=1 } else { if(run>0) tot+=triangular(run); run=1 } prev=v } if(run>0) tot+=triangular(run); return tot }
function naturalScore(){ const S=new Set(frontierNumbers); frontierX.forEach(n=>S.delete(n)); return S.size }
function compScore(){ const sciEnd=calcScienceFromResearch(); const my={sci:res.sci+sciEnd, ind:res.ind, dip:res.dip, art:res.art}; return (my.sci>=25) + (my.ind>=25) + (my.dip>=15) + (my.art>=14) }
function rating(total){ if(total<20) return ['ğŸº','çŸ¥ã‚‰ã‚Œã–ã‚‹å°æ–‡æ˜']; if(total<25) return ['ğŸ›ï¸','ãã‚Œãªã‚Šã®æ–‡æ˜']; if(total<30) return ['ğŸ“œâœ¨','æ­´å²ã«æ®‹ã£ãŸå¤§æ–‡æ˜']; if(total<35) return ['ğŸ‘‘ğŸ°','ä»ŠãªãŠãŠå®¶ç¶šãå‰å¤§ãªæ–‡æ˜']; return ['ğŸš€ğŸŒŒ','å®‡å®™ã¸ç‰ˆå›³ã‚’åºƒã’ã‚‹è¦‡è€…æ–‡æ˜'] }
document.getElementById('scoreBtn').onclick=()=>{
  const sciEnd=calcScienceFromResearch(); const inv=res.inv; const cultureMin=Math.min(res.food, res.sci+sciEnd, res.ind); const comp=compScore(); const nat=naturalScore(); const total=inv+cultureMin+comp+nat; const [emj,ttl]=rating(total);
  r('scoreOut').innerHTML=`ğŸ’¡=${inv}, æ–‡åŒ–(min)=${cultureMin}, ç«¶äº‰=${comp}, è‡ªç„¶=${nat} â†’ <b>åˆè¨ˆ ${total}</b>ï¼ˆğŸ§ª=${res.sci}+${sciEnd}ï¼‰<div class="hist" style="margin-top:8px"><b>${emj} ${ttl}</b> / ã‚ãªãŸã®æ–‡æ˜ã¯ <b>${total}</b> ç‚¹ï¼</div>`;
  updateCityAndEra();
};

/* åˆæœŸåŒ– */
buildBoard(); updRes(); renderBaselineBar();
</script>
</body>
</html>
