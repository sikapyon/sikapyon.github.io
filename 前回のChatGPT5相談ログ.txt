ChatGPT:
ミニミニ・シヴィライゼーション ─ 対AI拡張 相談ログ（保存用）

最終更新: 2025-08-23

1) 現状まとめ

目的

25マス一筆書き 完走必須。

スコア最適化（文化min、発明、競争、自然）を意識した 対AI 行動計画を導入。

追加実装（mmc-vsai-extension.js）

モード選択に 「対AI（ふつう）」 を追加。

AI観戦パネル（自分の盤の右にAIの盤をミラー表示、ライン描画は隣接のみ）。

基準値共有：人間が置いた値＝基準値。AIが置いた値＝次ターンの共有基準。

updateBaseline をフックしてソロ挙動を抑止、交互共有へ。

スコア比較画面（2人対戦計算）：本体＋研究連(三角数)＋文化min＋競争＋自然。

AIが25手目まで完遂：人間が25/25でも、AIが動ける限り runAISolo() で最後まで進める。

基準値12に固定される不具合修正：#baseline から数値を素直に取得。

候補生成のtypo修正：s.length-1 → s.path.length-1。

ラインのワープ禁止：8近傍以外は描画しない。

2) いまのAIの考え方（セオリー反映）
優先順位（高→低）

完走（一筆書きで25/25）

スネーク（5×5 ハミルトン経路）を8通り用意。

現在位置から合法に継続できる回転を選び、フル先読み評価（最大25手、割引）でスコア化。

序盤の開拓を確保

初手は白限定（灰直踏み禁止）。

グレーを未開拓で踏むリスクを低減するため、基準超の奇数（特に 21, 23）を「開拓の起点」として高評価。

開拓番号の書込み先は 現在位置から近いグレーを優先（距離ペナルティ付き）。

研究連は 6～7 マス

三角数（昇順連）で評価。8以上は価値を伸ばしにくいので過大評価しない。

小さい数(1〜10)は可能な限り基準超で取得

ただし 1〜5 が教育になった場合の 🖋+2 は発明に近づくため 許容。

大きい数(16〜25)は可能な限り基準下で取得

23 と 25 は発明価値が高いので、必要なら💡で反転してでも基準下で取りに行く方針。

中央灰は弱い（食2/外2）

必要なら未開拓で踏み抜きを許可（詰み回避や経路維持を優先）。

3) 実装メモ（要点）
共有状態

vsAI.sharedBaseline … 共有基準値

vsAI.usedHuman / usedAI … 使用済み集合（Set）

vsAI.ai

vals[5][5]（白は5〜20乱数、灰は空）/ chosen[5][5] / path

res {food,sci,ind,art,dip,inv} / research[12]（null 埋め）

frontierX（使った開拓番号、自然点判定用）

tour（現在の計画ツアー）

評価関数の重み（_W）
inv 3.0 / art 0.85 / ind 0.85 / dip 0.85 / sci 0.85 / food 0.4
tri 0.95 / nat -0.6 / mobility 0.18 / stuck -8.0


inv を最重視、stuck で詰みを強く抑止。

nat は開拓で未使用番号が減る＝自然点減なのでマイナス。

1手適用 _applyAndScore(state,i,j,baselineNow)

アクション判定：

v > baselineNow & 奇数 → 開拓：

使える最小未使用開拓番号まで frontierX を進め、

近場のグレー（_nearestGreySpot）に書込み。greyGain を反映（🖋→💡連鎖あり）。

v > baselineNow & 偶数 → 研究：空スロットに置き、researchGain と三角数を反映（🖋→💡連鎖あり）。

それ以外 → 教育：🖋💡が点灯しそうなら🖋、そうでなければ⚙

増分 + 可動域（候補数）でスコア化。

続きの期待値

いまの1手を仮適用 → 人間の応手を 簡易予測（_predictHumanPickValue）→
そこから最良スネークを再構築してフル評価。

合成： total = r1.score + 0.65 * cont

開拓の書込み先

_nearestGreySpot(i,j,state)：現在位置(i,j)からのマンハッタン距離最小のグレー未使用セルを優先。

25手完走

人間が25/25 or 人間が詰み → vsAI.fallback = 'AI' で AI単独進行 runAISolo()。

4) 既知の課題 / 改善方針

グレー未開拓踏みの更なる抑制

現状でも初手灰は封じたが、序盤3手で開拓2回を目標に、

earlyターン専用の追加ボーナス/ペナルティを導入（例：T=0,1 で未開拓灰踏み大減点、開拓ボーナス）。

書込み先の距離ヒューリスティック強化

_nearestGreySpot に 「将来のツアー上での順番」 を加味（距離だけでなく、残りパス上の早さを優遇）。

23/25の特別扱い

基準下で拾える見込みがあるなら 強いバイアス（発明狙い）。

研究連 6〜7 で飽和

8以上のマージナルは切り捨て寄りの重み調整。

人間応手の分岐予測

いまは1候補のみ。2〜3分岐のミニMax（浅い）で基準推移を読む。

ハミルトニアン以外の保険

ツアーが破綻しそうな局面で、局所DFS＋詰み回避バイアス を併用。

5) 不具合と対処
A) 「9で開拓になったが、残りグレー無し」なのに番号選択UIが出る

期待挙動：開拓スロットが空いていても、書込み先がないときは食料+1 にフォールバック。

修正場所（本体JS側。HTMLではない）

検索ワード例："開拓番号を選択", "greyGain", "grey", "開拓"

開拓アクションの分岐直後に ガード を追加：

const hasWritableGrey = boardCells.some(c => c.isGrey && !c.value && !c.chosen);
if (!hasWritableGrey) {
  // 開拓先が無い → 仕様どおり 食料+1 で即終了
  rFood.textContent = (+rFood.textContent) + 1;
  return; // 番号選択UIに遷移しない
}
// 以降のみ 番号選択UI を表示


もし doDevelop() など関数分割されていれば、その入口で判定して UI を開かないようにする。

B) AIが2手目で未開拓灰を踏んだ

原因：初期版では「初手白限定」は導入済みだが2手目以降の強い抑制が無かった。

対応：

スコア関数に序盤ペナルティを追加済（最新版）。

なお、「中央灰は弱いが許容」例外は残す（詰み回避や最短経路維持のため）。

6) 次のTODO（実装順）

スコア関数に 序盤専用係数 を再強化：

T=0: 未開拓灰 -80, 研究+20, 基準直下教育 +8

T=1: 未開拓灰 -25, 研究+8

開拓の書込み先ヒューリスティック：

近さ + 将来のツアー順（早い地点）を加点。

23/25の特別重み：

基準下取得の可能性が高いとき +K、基準超で拾う見込みが高いときは温存へ誘導。

人間応手の2分岐予測（偶数>奇数>教育 の重みで候補2つまで）。

局所DFSの保険：

ツアーが非隣接で止まるときだけ周囲3手探索で詰み回避。

7) 再開手順

盤面を開く → 最新の mmc-vsai-extension.js を読み込む。

モードを 「対AI（ふつう）」 に変更。

不具合が再現する場合は、再現手順・スクショ・基準値遷移（履歴）をメモ。

上の TODO から順に反映・検証。

8) 参考（主要関数の役割）

baselineFromDOM() … 基準値の読み取り（固定12バグの修正点）

aiCandidates() / humanCandidates() … 8近傍の合法手

_applyAndScore() … 1手適用＆即時スコア（開拓/研究/教育＋連鎖）

_predictHumanPickValue() … 応手の簡易予測（基準推移）

_makeAllTours() / _firstPlayableRotation() / _scoreTourFullFrom() … スネーク全探索＋割引評価

_nearestGreySpot() … 現在位置から最短の灰（未使用）に書き込み先を決定

aiPick() … 1手先で仮適用→ツアー作り直し→合成スコア最大の手を返す

runAISolo() … 人間が終了or詰みのときもAIが25手まで完遂

9) メモ（セオリー再掲・チェックリスト）

 25マス完走を最優先。

 1〜3手で開拓2回が理想。

 研究連は 6〜7 で打ち止め目標。

 1〜10 はできるだけ基準上で取得。

 16〜25 とくに 23/25 は基準下で（💡活用も可）。

 1〜5 が教育になったら 🖋+2 を前向きに。

 中央灰は弱いので状況で未開拓踏みは許容。

 開拓書込みは 近場優先（将来のルートも意識）。

このテキストをそのままメモ帳に保存しておけば、次回ここから続けられます。必要なら、最後にあなた側の所感や実戦での気づきを追記しておいてくれると助かる！